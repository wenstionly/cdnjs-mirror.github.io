var __extends=this&&this.__extends||function(){var t=function(e,o){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])})(e,o)};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),__decorate=this&&this.__decorate||function(t,e,o,i){var r,n=arguments.length,s=n<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,o,i);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(s=(n<3?r(s):n>3?r(e,o,s):r(e,o))||s);return n>3&&s&&Object.defineProperty(e,o,s),s};import{Class}from"./Class";import{Texture}from"./Resources/Texture";import{InitializeEvent,KillEvent,PreUpdateEvent,PreDrawEvent,PreDebugDrawEvent,PostDebugDrawEvent,PostKillEvent,PreKillEvent}from"./Events";import{Color}from"./Drawing/Color";import{Sprite}from"./Drawing/Sprite";import{Logger}from"./Util/Log";import{ActionContext}from"./Actions/ActionContext";import{ActionQueue}from"./Actions/Action";import{Vector}from"./Algebra";import{Body}from"./Collision/Body";import{Configurable}from"./Configurable";import*as Traits from"./Traits/Index";import*as Effects from"./Drawing/SpriteEffects";import*as Util from"./Util/Util";import{CollisionType}from"./Collision/CollisionType";import{obsolete}from"./Util/Decorators";import{Collider}from"./Collision/Collider";import{Shape}from"./Collision/Shape";export function isActor(t){return t instanceof Actor};var ActorImpl=function(t){function e(o,i,r,n,s){var a=t.call(this)||this;a.id=e.maxId++,a._height=0,a._width=0,a.isOffScreen=!1,a.visible=!0,a.opacity=1,a.previousOpacity=1,a.logger=Logger.getInstance(),a.scene=null,a.parent=null,a.children=[],a._isInitialized=!1,a.frames={},a._effectsDirty=!1,a.currentDrawing=null,a._draggable=!1,a._dragging=!1,a._pointerDragStartHandler=function(){a._dragging=!0},a._pointerDragEndHandler=function(){a._dragging=!1},a._pointerDragMoveHandler=function(t){a._dragging&&(a.pos=t.pointer.lastWorldPos)},a._pointerDragLeaveHandler=function(t){a._dragging&&(a.pos=t.pointer.lastWorldPos)},a.traits=[],a.enableCapturePointer=!1,a.capturePointer={captureMoveEvents:!1,captureDragEvents:!1},a._zIndex=0,a._isKilled=!1,a._opacityFx=new Effects.Opacity(a.opacity),a._capturePointerEvents=["pointerup","pointerdown","pointermove","pointerenter","pointerleave","pointerdragstart","pointerdragend","pointerdragmove","pointerdragenter","pointerdragleave"],a._captureMoveEvents=["pointermove","pointerenter","pointerleave","pointerdragmove","pointerdragenter","pointerdragleave"],a._captureDragEvents=["pointerdragstart","pointerdragend","pointerdragmove","pointerdragenter","pointerdragleave"],a._initDefaults();var l=!0,h=CollisionType.Passive;if(o&&"object"==typeof o){var p=o;p.pos?(o=p.pos?p.pos.x:0,i=p.pos?p.pos.y:0):(o=p.x||0,i=p.y||0),r=p.width,n=p.height,p.body&&(l=!1,a.body=p.body),p.anchor&&(a.anchor=p.anchor),p.collisionType&&(h=p.collisionType)}return a._width=r||0,a._height=n||0,l&&(a.body=new Body({collider:new Collider({type:h,shape:Shape.Box(a._width,a._height,a.anchor)})})),a.pos.x=o||0,a.pos.y=i||0,s&&(a.color=s,a.opacity=s.a),a.traits.push(new Traits.TileMapCollisionDetection),a.traits.push(new Traits.OffscreenCulling),a.traits.push(new Traits.CapturePointer),a.actionQueue=new ActionQueue(a),a.actions=new ActionContext(a),a}return __extends(e,t),Object.defineProperty(e.prototype,"body",{get:function(){return this._body},set:function(t){this._body=t,this._body.actor=this},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pos",{get:function(){return this.body.pos},set:function(t){this.body.pos.setTo(t.x,t.y)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"oldPos",{get:function(){return this.body.oldPos},set:function(t){this.body.oldPos.setTo(t.x,t.y)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"vel",{get:function(){return this.body.vel},set:function(t){this.body.vel.setTo(t.x,t.y)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"oldVel",{get:function(){return this.body.oldVel},set:function(t){this.body.oldVel.setTo(t.x,t.y)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"acc",{get:function(){return this.body.acc},set:function(t){this.body.acc.setTo(t.x,t.y)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"oldAcc",{get:function(){return this.body.oldAcc},set:function(t){this.body.oldAcc.setTo(t.x,t.y)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rotation",{get:function(){return this.body.rotation},set:function(t){this.body.rotation=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rx",{get:function(){return this.body.rx},set:function(t){this.body.rx=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scale",{get:function(){return this.body.scale},set:function(t){this.body.scale=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"oldScale",{get:function(){return this.body.oldScale},set:function(t){this.body.oldScale=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"sx",{get:function(){return this.body.sx},set:function(t){this.body.sx=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"sy",{get:function(){return this.body.sy},set:function(t){this.body.sy=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"draggable",{get:function(){return this._draggable},set:function(t){t&&(t&&!this._draggable?(this.on("pointerdragstart",this._pointerDragStartHandler),this.on("pointerdragend",this._pointerDragEndHandler),this.on("pointerdragmove",this._pointerDragMoveHandler),this.on("pointerdragleave",this._pointerDragLeaveHandler)):!t&&this._draggable&&(this.off("pointerdragstart",this._pointerDragStartHandler),this.off("pointerdragend",this._pointerDragEndHandler),this.off("pointerdragmove",this._pointerDragMoveHandler),this.off("pointerdragleave",this._pointerDragLeaveHandler)),this._draggable=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"color",{get:function(){return this._color},set:function(t){this._color=t.clone()},enumerable:!1,configurable:!0}),e.prototype.onInitialize=function(t){},Object.defineProperty(e.prototype,"isInitialized",{get:function(){return this._isInitialized},enumerable:!1,configurable:!0}),e.prototype._initialize=function(e){this.isInitialized||(this.onInitialize(e),t.prototype.emit.call(this,"initialize",new InitializeEvent(e,this)),this._isInitialized=!0);for(var o=0,i=this.children;o<i.length;o++){i[o]._initialize(e)}},e.prototype._initDefaults=function(){this.anchor=Actor.defaults.anchor.clone()},e.prototype._checkForPointerOptIn=function(t){if(t){var e=t.toLowerCase();-1!==this._capturePointerEvents.indexOf(e)&&(this.enableCapturePointer=!0,-1!==this._captureMoveEvents.indexOf(e)&&(this.capturePointer.captureMoveEvents=!0),-1!==this._captureDragEvents.indexOf(e)&&(this.capturePointer.captureDragEvents=!0))}},e.prototype.on=function(e,o){this._checkForPointerOptIn(e),t.prototype.on.call(this,e,o)},e.prototype.once=function(e,o){this._checkForPointerOptIn(e),t.prototype.once.call(this,e,o)},e.prototype.off=function(e,o){t.prototype.off.call(this,e,o)},e.prototype._prekill=function(e){t.prototype.emit.call(this,"prekill",new PreKillEvent(this)),this.onPreKill(e)},e.prototype.onPreKill=function(t){},e.prototype._postkill=function(e){t.prototype.emit.call(this,"postkill",new PostKillEvent(this)),this.onPostKill(e)},e.prototype.onPostKill=function(t){},e.prototype.kill=function(){this.scene?(this._prekill(this.scene),this.emit("kill",new KillEvent(this)),this._isKilled=!0,this.scene.remove(this),this._postkill(this.scene)):this.logger.warn("Cannot kill actor, it was never added to the Scene")},e.prototype.unkill=function(){this._isKilled=!1},e.prototype.isKilled=function(){return this._isKilled},e.prototype.add=function(t){t.body.collider.type=CollisionType.PreventCollision,Util.addItemToArray(t,this.children)&&(t.parent=this)},e.prototype.remove=function(t){Util.removeItemFromArray(t,this.children)&&(t.parent=null)},e.prototype.setDrawing=function(t){t=t.toString(),this.currentDrawing!==this.frames[t]&&(null!=this.frames[t]?(this.frames[t].reset(),this.currentDrawing=this.frames[t]):Logger.getInstance().error("the specified drawing key "+t+" does not exist"))},e.prototype.addDrawing=function(){2===arguments.length?(this.frames[arguments[0]]=arguments[1],this.currentDrawing||(this.currentDrawing=arguments[1]),this._effectsDirty=!0):(arguments[0]instanceof Sprite&&this.addDrawing("default",arguments[0]),arguments[0]instanceof Texture&&this.addDrawing("default",arguments[0].asSprite()))},Object.defineProperty(e.prototype,"z",{get:function(){return this.getZIndex()},set:function(t){this.setZIndex(t)},enumerable:!1,configurable:!0}),e.prototype.getZIndex=function(){return this._zIndex},e.prototype.setZIndex=function(t){this.scene.cleanupDrawTree(this),this._zIndex=t,this.scene.updateDrawTree(this)},Object.defineProperty(e.prototype,"center",{get:function(){return new Vector(this.pos.x+this.width/2-this.anchor.x*this.width,this.pos.y+this.height/2-this.anchor.y*this.height)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this._width*this.getGlobalScale().x},set:function(t){this._width=t/this.scale.x,this.body.collider.shape=Shape.Box(this._width,this._height,this.anchor),this.body.markCollisionShapeDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this._height*this.getGlobalScale().y},set:function(t){this._height=t/this.scale.y,this.body.collider.shape=Shape.Box(this._width,this._height,this.anchor),this.body.markCollisionShapeDirty()},enumerable:!1,configurable:!0}),e.prototype.getWorldRotation=function(){return this.parent?this.rotation+this.parent.getWorldRotation():this.rotation},e.prototype.getWorldPos=function(){if(!this.parent)return this.pos.clone();var t=[],e=this;for(t.push(this);e.parent;)e=e.parent,t.push(e);var o=t.reduceRight(function(t,e){return e.parent?t+e.pos.x*e.getGlobalScale().x:t+e.pos.x},0),i=t.reduceRight(function(t,e){return e.parent?t+e.pos.y*e.getGlobalScale().y:t+e.pos.y},0),r=e.getWorldPos(),n=this.getWorldRotation();return new Vector(o,i).rotate(n,r)},e.prototype.getGlobalScale=function(){if(!this.parent)return new Vector(this.scale.x,this.scale.y);var t=this.parent.getGlobalScale();return new Vector(this.scale.x*t.x,this.scale.y*t.y)},e.prototype.contains=function(t,e,o){void 0===o&&(o=!1);var i=this.getWorldPos().sub(this.pos),r=this.body.collider.bounds.translate(i).contains(new Vector(t,e));return o?r||this.children.some(function(o){return o.contains(t,e,!0)}):r},e.prototype.within=function(t,e){return this.body.collider.shape.getClosestLineBetween(t.body.collider.shape).getLength()<=e},e.prototype._reapplyEffects=function(t){t.removeEffect(this._opacityFx),t.addEffect(this._opacityFx)},e.prototype.update=function(t,e){this._initialize(t),this._preupdate(t,e),this.actionQueue.update(e),this.color&&(this.color.a=this.opacity),0===this.opacity&&(this.visible=!1),this.previousOpacity!==this.opacity&&(this.previousOpacity=this.opacity,this._opacityFx.opacity=this.opacity,this._effectsDirty=!0),this.body.captureOldTransform(),this.body.integrate(e);for(var o=0,i=this.traits;o<i.length;o++){i[o].update(this,t,e)}for(var r=0;r<this.children.length;r++)this.children[r].update(t,e);this._postupdate(t,e)},e.prototype.onPreUpdate=function(t,e){},e.prototype.onPostUpdate=function(t,e){},e.prototype._preupdate=function(t,e){this.emit("preupdate",new PreUpdateEvent(t,e,this)),this.onPreUpdate(t,e)},e.prototype._postupdate=function(t,e){this.emit("postupdate",new PreUpdateEvent(t,e,this)),this.onPostUpdate(t,e)},e.prototype.draw=function(t,e){if(t.save(),t.translate(this.pos.x,this.pos.y),t.rotate(this.rotation),t.scale(this.scale.x,this.scale.y),t.save(),t.translate(-this._width*this.anchor.x,-this._height*this.anchor.y),this._predraw(t,e),this.currentDrawing){var o=this.currentDrawing,i=(this._width-o.width*o.scale.x)*this.anchor.x,r=(this._height-o.height*o.scale.y)*this.anchor.y;this._effectsDirty&&(this._reapplyEffects(this.currentDrawing),this._effectsDirty=!1),this.currentDrawing.draw(t,i,r)}else this.color&&this.body&&this.body.collider&&this.body.collider.shape&&this.body.collider.shape.draw(t,this.color,new Vector(this.width*this.anchor.x,this.height*this.anchor.y));t.restore();for(var n=0;n<this.children.length;n++)this.children[n].visible&&this.children[n].draw(t,e);this._postdraw(t,e),t.restore()},e.prototype.onPreDraw=function(t,e){},e.prototype.onPostDraw=function(t,e){},e.prototype._predraw=function(t,e){this.emit("predraw",new PreDrawEvent(t,e,this)),this.onPreDraw(t,e)},e.prototype._postdraw=function(t,e){this.emit("postdraw",new PreDrawEvent(t,e,this)),this.onPostDraw(t,e)},e.prototype.debugDraw=function(t){this.emit("predebugdraw",new PreDebugDrawEvent(t,this)),this.body.collider.debugDraw(t);var e=this.body.collider.localBounds.translate(this.getWorldPos());e.debugDraw(t),t.fillText("id: "+this.id,e.left+3,e.top+10),t.fillStyle=Color.Yellow.toString(),t.beginPath(),t.arc(this.getWorldPos().x,this.getWorldPos().y,3,0,2*Math.PI),t.closePath(),t.fill();for(var o=0;o<this.traits.length;o++)this.traits[o]instanceof Traits.OffscreenCulling&&this.traits[o].cullingBox.debugDraw(t);t.strokeStyle=Color.Yellow.toString(),t.beginPath();var i=Math.min(this.width,this.height);t.arc(this.getWorldPos().x,this.getWorldPos().y,i,0,2*Math.PI),t.closePath(),t.stroke();var r={"0 Pi":0,"Pi/2":Math.PI/2,Pi:Math.PI,"3/2 Pi":3*Math.PI/2},n=t.font;for(var s in r)t.fillStyle=Color.Yellow.toString(),t.font="14px",t.textAlign="center",t.fillText(s,this.getWorldPos().x+Math.cos(r[s])*(i+10),this.getWorldPos().y+Math.sin(r[s])*(i+10));t.font=n;for(var a=0;a<this.children.length;a++)this.children[a].debugDraw(t);this.emit("postdebugdraw",new PostDebugDrawEvent(t,this))},e.prototype.getAncestors=function(){for(var t,e=[this],o=this;t=o.parent;)o=t,e.push(o);return e.reverse()},e.defaults={anchor:Vector.Half},e.maxId=0,__decorate([obsolete({message:"ex.Actor.sx will be removed in v0.25.0",alternateMethod:"Set width and height directly in constructor"})],e.prototype,"sx",null),__decorate([obsolete({message:"ex.Actor.sy will be removed in v0.25.0",alternateMethod:"Set width and height directly in constructor"})],e.prototype,"sy",null),e}(Class);export{ActorImpl};var Actor=function(t){function e(e,o,i,r,n){return t.call(this,e,o,i,r,n)||this}return __extends(e,t),e}(Configurable(ActorImpl));export{Actor};