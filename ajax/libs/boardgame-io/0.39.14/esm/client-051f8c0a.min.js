import{compose,applyMiddleware,createStore}from"redux";import{A as ActionCreators,r as reset,u as undo,q as redo,M as MAKE_MOVE,G as GAME_EVENT,R as RESET,j as UPDATE,k as SYNC}from"./turn-order-d7fe23d9.js";import{P as ProcessGameConfig,C as CreateGameReducer}from"./reducer-186c7602.js";import{D as Debug}from"./Debug-b191d299.js";import{I as InitializeGame}from"./initialize-f1052b38.js";function createDispatchers(t,e,s,i,a,r){return e.reduce((e,n)=>(e[n]=function(...e){let l=i;if(!r&&null==i){l=s.getState().ctx.currentPlayer}s.dispatch(ActionCreators[t](n,e,l,a))},e),{})}const createMoveDispatchers=createDispatchers.bind(null,"makeMove"),createEventDispatchers=createDispatchers.bind(null,"gameEvent"),createPluginDispatchers=createDispatchers.bind(null,"plugin");class _ClientImpl{constructor({game:t,debug:e,numPlayers:s,multiplayer:i,gameID:a,playerID:r,credentials:n,enhancer:l}){this.game=ProcessGameConfig(t),this.playerID=r,this.gameID=a,this.credentials=n,this.multiplayer=i,this.debug=e,this.gameStateOverride=null,this.subscribers={},this._running=!1,this.reducer=CreateGameReducer({game:this.game,isClient:void 0!==i}),this.initialState=null,i||(this.initialState=InitializeGame({game:this.game,numPlayers:s})),this.reset=(()=>{this.store.dispatch(reset(this.initialState))}),this.undo=(()=>{this.store.dispatch(undo(this.playerID,this.credentials))}),this.redo=(()=>{this.store.dispatch(redo(this.playerID,this.credentials))}),this.store=null,this.log=[];const h=t=>e=>s=>{const i=e(s),a=t.getState();switch(s.type){case MAKE_MOVE:case GAME_EVENT:{const t=a.deltalog;this.log=[...this.log,...t];break}case RESET:this.log=[];break;case UPDATE:{let t=-1;this.log.length>0&&(t=this.log[this.log.length-1]._stateID);let e=s.deltalog||[];e=e.filter(e=>e._stateID>t),this.log=[...this.log,...e];break}case SYNC:this.initialState=s.initialState,this.log=s.log||[]}return i},c=t=>e=>s=>{const i=t.getState(),a=e(s);return"clientOnly"in s||this.transport.onAction(i,s),a},o=()=>t=>e=>{const s=t(e);return this.notifySubscribers(),s};l=void 0!==l?compose(applyMiddleware(o,c,h),l):applyMiddleware(o,c,h),this.store=createStore(this.reducer,this.initialState,l),this.transport={isConnected:!0,onAction:()=>{},subscribe:()=>{},subscribeGameMetadata:()=>{},connect:()=>{},disconnect:()=>{},updateGameID:()=>{},updatePlayerID:()=>{}},i&&(this.transport=i({gameKey:t,game:this.game,store:this.store,gameID:a,playerID:r,gameName:this.game.name,numPlayers:s})),this.createDispatchers(),this.transport.subscribeGameMetadata(t=>{this.gameMetadata=t}),this._debugPanel=null}notifySubscribers(){Object.values(this.subscribers).forEach(t=>t(this.getState()))}overrideGameState(t){this.gameStateOverride=t,this.notifySubscribers()}start(){this.transport.connect(),this._running=!0;let t=null;if("production"!==process.env.NODE_ENV&&(t=Debug),this.debug&&!0!==this.debug&&this.debug.impl&&(t=this.debug.impl),null!==t&&!1!==this.debug&&null==this._debugPanel&&"undefined"!=typeof document){let e=document.body;this.debug&&!0!==this.debug&&void 0!==this.debug.target&&(e=this.debug.target),e&&(this._debugPanel=new t({target:e,props:{client:this}}))}}stop(){this.transport.disconnect(),this._running=!1,null!=this._debugPanel&&(this._debugPanel.$destroy(),this._debugPanel=null)}subscribe(t){const e=Object.keys(this.subscribers).length;return this.subscribers[e]=t,this.transport.subscribe(()=>this.notifySubscribers()),!this._running&&this.multiplayer||t(this.getState()),()=>{delete this.subscribers[e]}}getInitialState(){return this.initialState}getState(){let t=this.store.getState();if(null!==this.gameStateOverride&&(t=this.gameStateOverride),null===t)return t;let e=!0;const s=this.game.flow.isPlayerActive(t.G,t.ctx,this.playerID);return this.multiplayer&&!s&&(e=!1),this.multiplayer||null===this.playerID||void 0===this.playerID||s||(e=!1),void 0!==t.ctx.gameover&&(e=!1),{...t,G:this.game.playerView(t.G,t.ctx,this.playerID),log:this.log,isActive:e,isConnected:this.transport.isConnected}}createDispatchers(){this.moves=createMoveDispatchers(this.game.moveNames,this.store,this.playerID,this.credentials,this.multiplayer),this.events=createEventDispatchers(this.game.flow.enabledEventNames,this.store,this.playerID,this.credentials,this.multiplayer),this.plugins=createPluginDispatchers(this.game.pluginNames,this.store,this.playerID,this.credentials,this.multiplayer)}updatePlayerID(t){this.playerID=t,this.createDispatchers(),this.transport.updatePlayerID(t),this.notifySubscribers()}updateGameID(t){this.gameID=t,this.createDispatchers(),this.transport.updateGameID(t),this.notifySubscribers()}updateCredentials(t){this.credentials=t,this.createDispatchers(),this.notifySubscribers()}}function Client(t){return new _ClientImpl(t)}export{Client as C};