import{o as makeMove,g as gameEvent,p as alea}from"./turn-order-b89c94e7.js";import{C as CreateGameReducer}from"./reducer-f8e7aa66.js";class Bot{constructor({enumerate:t,seed:e}){this.enumerateFn=t,this.seed=e,this.iterationCounter=0,this._opts={}}addOpt({key:t,range:e,initial:a}){this._opts[t]={range:e,value:a}}getOpt(t){return this._opts[t].value}setOpt(t,e){t in this._opts&&(this._opts[t].value=e)}opts(){return this._opts}enumerate(t,e,a){return this.enumerateFn(t,e,a).map(t=>"payload"in t?t:"move"in t?makeMove(t.move,t.args,a):"event"in t?gameEvent(t.event,t.args,a):void 0)}random(t){let e;if(void 0!==this.seed){let t=null;e=(t=this.prngstate?new alea("",{state:this.prngstate}):new alea(this.seed,{state:!0}))(),this.prngstate=t.state()}else e=Math.random();if(t){if(Array.isArray(t)){return t[Math.floor(e*t.length)]}return Math.floor(e*t)}return e}}const CHUNK_SIZE=25;class MCTSBot extends Bot{constructor({enumerate:t,seed:e,objectives:a,game:s,iterations:r,playoutDepth:i,iterationCallback:n}){super({enumerate:t,seed:e}),void 0===a&&(a=(()=>({}))),this.objectives=a,this.iterationCallback=n||(()=>{}),this.reducer=CreateGameReducer({game:s}),this.iterations=r,this.playoutDepth=i,this.addOpt({key:"async",initial:!1}),this.addOpt({key:"iterations",initial:"number"==typeof r?r:1e3,range:{min:1,max:2e3}}),this.addOpt({key:"playoutDepth",initial:"number"==typeof i?i:50,range:{min:1,max:100}})}createNode({state:t,parentAction:e,parent:a,playerID:s}){const{G:r,ctx:i}=t;let n=[],o=[];if(void 0!==s)n=this.enumerate(r,i,s),o=this.objectives(r,i,s);else if(i.activePlayers)for(let t in i.activePlayers)n=n.concat(this.enumerate(r,i,t)),o=o.concat(this.objectives(r,i,t));else n=n.concat(this.enumerate(r,i,i.currentPlayer)),o=o.concat(this.objectives(r,i,i.currentPlayer));return{state:t,parent:a,parentAction:e,actions:n,objectives:o,children:[],visits:0,value:0}}select(t){if(t.actions.length>0)return t;if(0==t.children.length)return t;let e=null,a=0;for(const s of t.children){const r=s.visits+Number.EPSILON,i=s.value/r+Math.sqrt(2*Math.log(t.visits)/r);(null==e||i>a)&&(a=i,e=s)}return this.select(e)}expand(t){const e=t.actions;if(0==e.length||void 0!==t.state.ctx.gameover)return t;const a=this.random(e.length),s=e[a];t.actions.splice(a,1);const r=this.reducer(t.state,s),i=this.createNode({state:r,parentAction:s,parent:t});return t.children.push(i),i}playout({state:t}){let e=this.getOpt("playoutDepth");"function"==typeof this.playoutDepth&&(e=this.playoutDepth(t.G,t.ctx));for(let a=0;a<e&&void 0===t.ctx.gameover;a++){const{G:e,ctx:a}=t;let s=a.currentPlayer;a.activePlayers&&(s=Object.keys(a.activePlayers)[0]);const r=this.enumerate(e,a,s),i=this.objectives(e,a,s),n=Object.keys(i).reduce((t,s)=>{const r=i[s];return r.checker(e,a)?t+r.weight:t},0);if(n>0)return{score:n};if(!r||0==r.length)return;const o=this.random(r.length);t=this.reducer(t,r[o])}return t.ctx.gameover}backpropagate(t,e={}){t.visits++,void 0!==e.score&&(t.value+=e.score),!0===e.draw&&(t.value+=.5),t.parentAction&&e.winner===t.parentAction.payload.playerID&&t.value++,t.parent&&this.backpropagate(t.parent,e)}play(t,e){const a=this.createNode({state:t,playerID:e});let s=this.getOpt("iterations");"function"==typeof this.iterations&&(s=this.iterations(t.G,t.ctx));const r=()=>{let t=null;for(const e of a.children)(null==t||e.visits>t.visits)&&(t=e);return{action:t&&t.parentAction,metadata:a}};return new Promise(t=>{const e=()=>{for(let t=0;t<CHUNK_SIZE&&this.iterationCounter<s;t++){const t=this.select(a),e=this.expand(t),s=this.playout(e);this.backpropagate(e,s),this.iterationCounter++}this.iterationCallback({iterationCounter:this.iterationCounter,numIterations:s,metadata:a})};if(this.iterationCounter=0,this.getOpt("async")){const a=()=>{this.iterationCounter<s?(e(),setTimeout(a,0)):t(r())};a()}else{for(;this.iterationCounter<s;)e();t(r())}})}}class RandomBot extends Bot{play({G:t,ctx:e},a){const s=this.enumerate(t,e,a);return Promise.resolve({action:this.random(s)})}}async function Step(t,e){const a=t.store.getState();let s=a.ctx.currentPlayer;a.ctx.activePlayers&&(s=Object.keys(a.ctx.activePlayers)[0]);const{action:r,metadata:i}=await e.play(a,s);if(r){const e={...r,payload:{...r.payload,metadata:i}};return t.store.dispatch(e),e}}async function Simulate({game:t,bots:e,state:a,depth:s}){void 0===s&&(s=1e4);const r=CreateGameReducer({game:t});let i=null,n=0;for(;void 0===a.ctx.gameover&&n<s;){let t=a.ctx.currentPlayer;a.ctx.activePlayers&&(t=Object.keys(a.ctx.activePlayers)[0]);const s=e instanceof Bot?e:e[t],o=await s.play(a,t);if(!o.action)break;i=o.metadata,a=r(a,o.action),n++}return{state:a,metadata:i}}export{Bot as B,MCTSBot as M,RandomBot as R,Step as S,Simulate as a};