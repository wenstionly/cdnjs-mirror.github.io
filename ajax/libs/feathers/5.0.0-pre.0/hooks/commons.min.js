"use strict";var __awaiter=this&&this.__awaiter||function(o,e,r,t){return new(r||(r=Promise))(function(n,s){function a(o){try{c(t.next(o))}catch(o){s(o)}}function i(o){try{c(t.throw(o))}catch(o){s(o)}}function c(o){var e;o.done?n(o.value):(e=o.value,e instanceof r?e:new r(function(o){o(e)})).then(a,i)}c((t=t.apply(o,e||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.wrap=exports.errorWrapper=exports.finallyWrapper=exports.afterWrapper=exports.beforeWrapper=exports.toFinallyHook=exports.toErrorHook=exports.toAfterHook=exports.toBeforeHook=exports.lastHook=exports.firstHook=exports.enableHooks=exports.processHooks=exports.getHooks=exports.isHookObject=exports.convertHookData=exports.makeArguments=exports.defaultMakeArguments=exports.createHookObject=exports.ACTIVATE_HOOKS=void 0;const hooks_1=require("@feathersjs/hooks"),commons_1=require("@feathersjs/commons"),{each:each,pick:pick,omit:omit}=commons_1._,noop=()=>{};function createHookObject(o,e={}){const r={};return Object.defineProperty(r,"toJSON",{value(){return pick(this,"type","method","path","params","id","data","result","error")}}),Object.assign(r,e,{method:o,get path(){const{app:o,service:r}=e;return r&&o&&o.services?Object.keys(o.services).find(e=>o.services[e]===r):null}})}function defaultMakeArguments(o){const e=[];return void 0!==o.id&&e.push(o.id),o.data&&e.push(o.data),e.push(o.params||{}),e}function makeArguments(o){switch(o.method){case"find":return[o.params];case"get":case"remove":return[o.id,o.params];case"update":case"patch":return[o.id,o.data,o.params];case"create":return[o.data,o.params]}return defaultMakeArguments(o)}function convertHookData(o){let e={};return Array.isArray(o)?e={all:o}:"object"!=typeof o?e={all:[o]}:each(o,function(o,r){e[r]=Array.isArray(o)?o:[o]}),e}function isHookObject(o){return o instanceof hooks_1.HookContext||"object"==typeof o&&"string"==typeof o.method&&"string"==typeof o.type}function getHooks(o,e,r,t,n=!1){const s=o.__hooks[r][t]||[],a=e.__hooks[r][t]||[];return n?a.concat(s):s.concat(a)}function processHooks(o,e){let r=e;const t=o=>{if(o){if(!isHookObject(o))throw new Error(`${r.type} hook for '${r.method}' method returned invalid hook object`);r=o}return r};return o.reduce((o,e)=>{const r=e.bind(this);return o.then(o=>r(o)).then(t)},Promise.resolve(r)).then(()=>r).catch(o=>{throw o.hook=r,o})}function enableHooks(o,e,r){if("function"==typeof o.hooks)return o;const t={};return r.forEach(o=>{t[o]={}}),Object.defineProperty(o,"__hooks",{configurable:!0,value:t,writable:!0}),Object.assign(o,{hooks(o){return each(o,(o,r)=>{if(!this.__hooks[r])throw new Error(`'${r}' is not a valid hook type`);const t=convertHookData(o);each(t,(o,r)=>{if("all"!==r&&-1===e.indexOf(r))throw new Error(`'${r}' is not a valid hook method`)}),e.forEach(o=>{const e=this.__hooks[r][o]||(this.__hooks[r][o]=[]);t.all&&e.push.apply(e,t.all),t[o]&&e.push.apply(e,t[o])})}),this}})}function handleError(o,e,r){return __awaiter(this,void 0,void 0,function*(){try{const t=yield o.call(e.self,e);Object.assign(e,omit(t,"arguments"))}catch(o){throw"function"==typeof r&&r(o,e),o}if(void 0!==e.error)throw e.error})}function firstHook(o,e){return o.type="before",e()}function lastHook(o,e){return o.type="after",e()}function toBeforeHook(o){return(e,r)=>__awaiter(this,void 0,void 0,function*(){const t=yield o.call(e.self,e);Object.assign(e,omit(t,"arguments")),yield r()})}function toAfterHook(o){return(e,r)=>__awaiter(this,void 0,void 0,function*(){yield r();const t=yield o.call(e.self,e);Object.assign(e,omit(t,"arguments"))})}function toErrorHook(o,e,r){return(t,n)=>__awaiter(this,void 0,void 0,function*(){try{yield n()}catch(n){"function"==typeof r&&r(t),t.error=n,t.result=void 0,yield handleError(o,t,e)}})}function toFinallyHook(o,e,r){return(t,n)=>__awaiter(this,void 0,void 0,function*(){try{yield n()}catch(o){throw o}finally{"function"==typeof r&&r(t),yield handleError(o,t,e)}})}function beforeWrapper(o){return[firstHook,...[].concat(o).map(toBeforeHook)]}function afterWrapper(o){return[...[].concat(o).reverse().map(toAfterHook),lastHook]}function finallyWrapper(o){let e;const r=(o,r)=>{e=o,r.error=o,r.result=void 0},t=()=>{if(e)throw e};return[].concat(o).reverse().map(o=>toFinallyHook(o,r,t))}function errorWrapper(o){let e;const r=(o,r)=>{e=o,r.error=o,r.result=void 0},t=o=>{if(o.original||(o.original=Object.assign({},o)),e)throw e;o.type="error"};return[noop].concat(o).reverse().map(o=>toErrorHook(o,r,t))}function wrap({async:o=[],before:e=[],after:r=[]}={}){return[...[].concat(o),...beforeWrapper(e),...afterWrapper(r)]}exports.ACTIVATE_HOOKS=commons_1.createSymbol("__feathersActivateHooks"),exports.createHookObject=createHookObject,exports.defaultMakeArguments=defaultMakeArguments,exports.makeArguments=makeArguments,exports.convertHookData=convertHookData,exports.isHookObject=isHookObject,exports.getHooks=getHooks,exports.processHooks=processHooks,exports.enableHooks=enableHooks,exports.firstHook=firstHook,exports.lastHook=lastHook,exports.toBeforeHook=toBeforeHook,exports.toAfterHook=toAfterHook,exports.toErrorHook=toErrorHook,exports.toFinallyHook=toFinallyHook,exports.beforeWrapper=beforeWrapper,exports.afterWrapper=afterWrapper,exports.finallyWrapper=finallyWrapper,exports.errorWrapper=errorWrapper,exports.wrap=wrap;