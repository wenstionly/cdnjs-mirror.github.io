"use strict";import Chart from"../parts/Chart.js";import H from"../parts/Globals.js";var win=H.win,doc=H.doc;import"../parts/Options.js";import SVGRenderer from"../parts/SVGRenderer.js";import U from"../parts/Utilities.js";var addEvent=U.addEvent,error=U.error,extend=U.extend,getOptions=U.getOptions,merge=U.merge;import"../mixins/download-url.js";var domurl=win.URL||win.webkitURL||win,nav=win.navigator,isMSBrowser=/Edge\/|Trident\/|MSIE /.test(nav.userAgent),loadEventDeferDelay=isMSBrowser?150:0;function getScript(t,e){var n=doc.getElementsByTagName("head")[0],o=doc.createElement("script");o.type="text/javascript",o.src=t,o.onload=e,o.onerror=function(){error("Error loading script "+t)},n.appendChild(o)}H.CanVGRenderer={},H.svgToDataUrl=function(t){var e=nav.userAgent.indexOf("WebKit")>-1&&nav.userAgent.indexOf("Chrome")<0;try{if(!e&&nav.userAgent.toLowerCase().indexOf("firefox")<0)return domurl.createObjectURL(new win.Blob([t],{type:"image/svg+xml;charset-utf-16"}))}catch(t){}return"data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(t)},H.imageToDataUrl=function(t,e,n,o,r,i,a,l,c){var s,d=new win.Image,g=function(){setTimeout(function(){var i,l=doc.createElement("canvas"),g=l.getContext&&l.getContext("2d");try{if(g){l.height=d.height*o,l.width=d.width*o,g.drawImage(d,0,0,l.width,l.height);try{i=l.toDataURL(e),r(i,e,n,o)}catch(r){s(t,e,n,o)}}else a(t,e,n,o)}finally{c&&c(t,e,n,o)}},loadEventDeferDelay)},p=function(){l(t,e,n,o),c&&c(t,e,n,o)};s=function(){d=new win.Image,s=i,d.crossOrigin="Anonymous",d.onload=g,d.onerror=p,d.src=t},d.onload=g,d.onerror=p,d.src=t},H.downloadSVGLocal=function(t,e,n,o){var r,i,a,l=!0,c=e.libURL||getOptions().exporting.libURL,s=doc.createElement("div"),d=e.type||"image/png",g=(e.filename||"chart")+"."+("image/svg+xml"===d?"svg":d.split("/")[1]),p=e.scale||1;function f(){s.innerHTML=t;var e,r,i,a,l,c,d,p=s.getElementsByTagName("text");[].forEach.call(p,function(t){["font-family","font-size"].forEach(function(e){!function(t,e){for(var n=t;n&&n!==s;){if(n.style[e]){t.style[e]=n.style[e];break}n=n.parentNode}}(t,e)}),t.style["font-family"]=t.style["font-family"]&&t.style["font-family"].split(" ").splice(-1),e=t.getElementsByTagName("title"),[].forEach.call(e,function(e){t.removeChild(e)})}),i=s.firstChild,a=0,l=i.width.baseVal.value+2*a,c=i.height.baseVal.value+2*a,d=new win.jsPDF(c>l?"p":"l","pt",[l,c]),[].forEach.call(i.querySelectorAll('*[visibility="hidden"]'),function(t){t.parentNode.removeChild(t)}),win.svg2pdf(i,d,{removeInvalid:!0}),r=d.output("datauristring");try{H.downloadURL(r,g),o&&o()}catch(t){n(t)}}if(c="/"!==c.slice(-1)?c+"/":c,"image/svg+xml"===d)try{void 0!==nav.msSaveOrOpenBlob?((i=new MSBlobBuilder).append(t),r=i.getBlob("image/svg+xml")):r=H.svgToDataUrl(t),H.downloadURL(r,g),o&&o()}catch(t){n(t)}else"application/pdf"===d?win.jsPDF&&win.svg2pdf?f():(l=!0,getScript(c+"jspdf.js",function(){getScript(c+"svg2pdf.js",function(){f()})})):(r=H.svgToDataUrl(t),a=function(){try{domurl.revokeObjectURL(r)}catch(t){}},H.imageToDataUrl(r,d,{},p,function(t){try{H.downloadURL(t,g),o&&o()}catch(t){n(t)}},function(){var e=doc.createElement("canvas"),r=e.getContext("2d"),i=t.match(/^<svg[^>]*width\s*=\s*\"?(\d+)\"?[^>]*>/)[1]*p,s=t.match(/^<svg[^>]*height\s*=\s*\"?(\d+)\"?[^>]*>/)[1]*p,f=function(){r.drawSvg(t,0,0,i,s);try{H.downloadURL(nav.msSaveOrOpenBlob?e.msToBlob():e.toDataURL(d),g),o&&o()}catch(t){n(t)}finally{a()}};e.width=i,e.height=s,win.canvg?f():(l=!0,getScript(c+"rgbcolor.js",function(){getScript(c+"canvg.js",function(){f()})}))},n,n,function(){l&&a()}))},Chart.prototype.getSVGForLocalExport=function(t,e,n,o){var r,i,a,l,c,s,d,g=this,p=0,f=function(t){return g.sanitizeSVG(t,a)},m=function(){p===r.length&&o(f(i.innerHTML))},h=function(t,e,n){++p,n.imageElement.setAttributeNS("http://www.w3.org/1999/xlink","href",t),m()};g.unbindGetSVG=addEvent(g,"getSVG",function(t){a=t.chartCopy.options,i=t.chartCopy.container.cloneNode(!0)}),g.getSVGForExport(t,e),r=i.getElementsByTagName("image");try{if(!r.length)return void o(f(i.innerHTML));for(c=0,s=r.length;c<s;++c)(d=(l=r[c]).getAttributeNS("http://www.w3.org/1999/xlink","href"))?H.imageToDataUrl(d,"image/png",{imageElement:l},t.scale,h,n,n,n):(++p,l.parentNode.removeChild(l),m())}catch(t){n(t)}g.unbindGetSVG()},Chart.prototype.exportChartLocal=function(t,e){var n=this,o=merge(n.options.exporting,t),r=function(t){!1===o.fallbackToExportServer?o.error?o.error(o,t):error(28,!0):n.exportChart(o)};isMSBrowser&&n.styledMode&&(SVGRenderer.prototype.inlineWhitelist=[/^blockSize/,/^border/,/^caretColor/,/^color/,/^columnRule/,/^columnRuleColor/,/^cssFloat/,/^cursor/,/^fill$/,/^fillOpacity/,/^font/,/^inlineSize/,/^length/,/^lineHeight/,/^opacity/,/^outline/,/^parentRule/,/^rx$/,/^ry$/,/^stroke/,/^textAlign/,/^textAnchor/,/^textDecoration/,/^transform/,/^vectorEffect/,/^visibility/,/^x$/,/^y$/]),isMSBrowser&&("application/pdf"===o.type||n.container.getElementsByTagName("image").length&&"image/svg+xml"!==o.type)||"application/pdf"===o.type&&[].some.call(n.container.getElementsByTagName("image"),function(t){var e=t.getAttribute("href");return""!==e&&0!==e.indexOf("data:")})?r("Image type not supported for this chart/browser."):n.getSVGForLocalExport(o,e,r,function(t){t.indexOf("<foreignObject")>-1&&"image/svg+xml"!==o.type?r("Image type not supportedfor charts with embedded HTML"):H.downloadSVGLocal(t,extend({filename:n.getFilename()},o),r)})},merge(!0,getOptions().exporting,{libURL:"https://code.highcharts.com/8.1.1/lib/",menuItemDefinitions:{downloadPNG:{textKey:"downloadPNG",onclick:function(){this.exportChartLocal()}},downloadJPEG:{textKey:"downloadJPEG",onclick:function(){this.exportChartLocal({type:"image/jpeg"})}},downloadSVG:{textKey:"downloadSVG",onclick:function(){this.exportChartLocal({type:"image/svg+xml"})}},downloadPDF:{textKey:"downloadPDF",onclick:function(){this.exportChartLocal({type:"application/pdf"})}}}});