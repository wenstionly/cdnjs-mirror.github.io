"use strict";import H from"../parts/Globals.js";import U from"../parts/Utilities.js";var addEvent=U.addEvent,attr=U.attr,extend=U.extend,format=U.format,fireEvent=U.fireEvent,isArray=U.isArray,isFunction=U.isFunction,isNumber=U.isNumber,isObject=U.isObject,merge=U.merge,objectEach=U.objectEach,pick=U.pick;import chartNavigationMixin from"../mixins/navigation.js";var doc=H.doc,win=H.win,PREFIX="highcharts-";function closestPolyfill(t,n){var e=win.Element.prototype,i=e.matches||e.msMatchesSelector||e.webkitMatchesSelector,o=null;if(e.closest)o=e.closest.call(t,n);else do{if(i.call(t,n))return t;t=t.parentElement||t.parentNode}while(null!==t&&1===t.nodeType);return o}var bindingsUtils={updateRectSize:function(t,n){var e=n.chart,i=n.options.typeOptions,o=e.pointer.getCoordinates(t),s=o.xAxis[0].value-i.point.x,a=i.point.y-o.yAxis[0].value;n.update({typeOptions:{background:{width:e.inverted?a:s,height:e.inverted?s:a}}})},getFieldType:function(t){return{string:"text",number:"number",boolean:"checkbox"}[typeof t]}},NavigationBindings=function(){function t(t,n){this.boundClassNames=void 0,this.selectedButton=void 0,this.chart=t,this.options=n,this.eventsToUnbind=[],this.container=doc.getElementsByClassName(this.options.bindingsClassName||"")}return t.prototype.initEvents=function(){var t=this,n=t.chart,e=t.container,i=t.options;t.boundClassNames={},objectEach(i.bindings||{},function(n){t.boundClassNames[n.className]=n}),[].forEach.call(e,function(n){t.eventsToUnbind.push(addEvent(n,"click",function(e){var i=t.getButtonEvents(n,e);i&&t.bindingsButtonClick(i.button,i.events,e)}))}),objectEach(i.events||{},function(n,e){isFunction(n)&&t.eventsToUnbind.push(addEvent(t,e,n))}),t.eventsToUnbind.push(addEvent(n.container,"click",function(e){!n.cancelClick&&n.isInsidePlot(e.chartX-n.plotLeft,e.chartY-n.plotTop)&&t.bindingsChartClick(this,e)})),t.eventsToUnbind.push(addEvent(n.container,"mousemove",function(n){t.bindingsContainerMouseMove(this,n)}))},t.prototype.initUpdate=function(){var t=this;chartNavigationMixin.addUpdate(function(n){t.update(n)},this.chart)},t.prototype.bindingsButtonClick=function(t,n,e){var i=this.chart;this.selectedButtonElement&&(fireEvent(this,"deselectButton",{button:this.selectedButtonElement}),this.nextEvent&&(this.currentUserDetails&&"annotations"===this.currentUserDetails.coll&&i.removeAnnotation(this.currentUserDetails),this.mouseMoveEvent=this.nextEvent=!1)),this.selectedButton=n,this.selectedButtonElement=t,fireEvent(this,"selectButton",{button:t}),n.init&&n.init.call(this,t,e),(n.start||n.steps)&&i.renderer.boxWrapper.addClass(PREFIX+"draw-mode")},t.prototype.bindingsChartClick=function(t,n){t=this.chart;var e=this.selectedButton,i=t.renderer.boxWrapper;this.activeAnnotation&&!n.activeAnnotation&&n.target.parentNode&&!closestPolyfill(n.target,"."+PREFIX+"popup")&&(fireEvent(this,"closePopup"),this.deselectAnnotation()),e&&e.start&&(this.nextEvent?(this.nextEvent(n,this.currentUserDetails),this.steps&&(this.stepIndex++,e.steps[this.stepIndex]?this.mouseMoveEvent=this.nextEvent=e.steps[this.stepIndex]:(fireEvent(this,"deselectButton",{button:this.selectedButtonElement}),i.removeClass(PREFIX+"draw-mode"),e.end&&e.end.call(this,n,this.currentUserDetails),this.nextEvent=!1,this.mouseMoveEvent=!1,this.selectedButton=null))):(this.currentUserDetails=e.start.call(this,n),e.steps?(this.stepIndex=0,this.steps=!0,this.mouseMoveEvent=this.nextEvent=e.steps[this.stepIndex]):(fireEvent(this,"deselectButton",{button:this.selectedButtonElement}),i.removeClass(PREFIX+"draw-mode"),this.steps=!1,this.selectedButton=null,e.end&&e.end.call(this,n,this.currentUserDetails))))},t.prototype.bindingsContainerMouseMove=function(t,n){this.mouseMoveEvent&&this.mouseMoveEvent(n,this.currentUserDetails)},t.prototype.fieldsToOptions=function(t,n){return objectEach(t,function(t,e){var i=parseFloat(t),o=e.split("."),s=n,a=o.length-1;!isNumber(i)||t.match(/px/g)||e.match(/format/g)||(t=i),""!==t&&"undefined"!==t&&o.forEach(function(n,e){var i=pick(o[e+1],"");a===e?s[n]=t:s[n]?s=s[n]:(s[n]=i.match(/\d/g)?[]:{},s=s[n])})}),n},t.prototype.deselectAnnotation=function(){this.activeAnnotation&&(this.activeAnnotation.setControlPointsVisibility(!1),this.activeAnnotation=!1)},t.prototype.annotationToFields=function(n){var e=n.options,i=t.annotationsEditable,o=i.nestedOptions,s=this.utils.getFieldType,a=pick(e.type,e.shapes&&e.shapes[0]&&e.shapes[0].type,e.labels&&e.labels[0]&&e.labels[0].itemType,"label"),r=t.annotationsNonEditable[e.langKey]||[],c={langKey:e.langKey,type:a};function l(t,e,i,a){var c;i&&-1===r.indexOf(e)&&((i.indexOf&&i.indexOf(e))>=0||i[e]||!0===i)&&(isArray(t)?(a[e]=[],t.forEach(function(t,n){isObject(t)?(a[e][n]={},objectEach(t,function(t,i){l(t,i,o[e],a[e][n])})):l(t,0,o[e],a[e])})):isObject(t)?(c={},isArray(a)?(a.push(c),c[e]={},c=c[e]):a[e]=c,objectEach(t,function(t,n){l(t,n,0===e?i:o[e],c)})):"format"===e?a[e]=[format(t,n.labels[0].points[0]).toString(),"text"]:isArray(a)?a.push([t,s(t)]):a[e]=[t,s(t)])}return objectEach(e,function(t,n){"typeOptions"===n?(c[n]={},objectEach(e[n],function(t,e){l(t,e,o,c[n])})):l(t,n,i[a],c)}),c},t.prototype.getClickedClassNames=function(t,n){for(var e,i=n.target,o=[];i;)if((e=attr(i,"class"))&&(o=o.concat(e.split(" ").map(function(t){return[t,i]}))),(i=i.parentNode)===t)return o;return o},t.prototype.getButtonEvents=function(t,n){var e,i=this;return this.getClickedClassNames(t,n).forEach(function(t){i.boundClassNames[t[0]]&&!e&&(e={events:i.boundClassNames[t[0]],button:t[1]})}),e},t.prototype.update=function(t){this.options=merge(!0,this.options,t),this.removeEvents(),this.initEvents()},t.prototype.removeEvents=function(){this.eventsToUnbind.forEach(function(t){t()})},t.prototype.destroy=function(){this.removeEvents()},t.annotationsEditable={nestedOptions:{labelOptions:["style","format","backgroundColor"],labels:["style"],label:["style"],style:["fontSize","color"],background:["fill","strokeWidth","stroke"],innerBackground:["fill","strokeWidth","stroke"],outerBackground:["fill","strokeWidth","stroke"],shapeOptions:["fill","strokeWidth","stroke"],shapes:["fill","strokeWidth","stroke"],line:["strokeWidth","stroke"],backgroundColors:[!0],connector:["fill","strokeWidth","stroke"],crosshairX:["strokeWidth","stroke"],crosshairY:["strokeWidth","stroke"]},circle:["shapes"],verticalLine:[],label:["labelOptions"],measure:["background","crosshairY","crosshairX"],fibonacci:[],tunnel:["background","line","height"],pitchfork:["innerBackground","outerBackground"],rect:["shapes"],crookedLine:[],basicAnnotation:[]},t.annotationsNonEditable={rectangle:["crosshairX","crosshairY","label"]},t}();function selectableAnnotation(t){var n=t.prototype.defaultOptions.events&&t.prototype.defaultOptions.events.click;merge(!0,t.prototype.defaultOptions.events,{click:function(t){var e=this,i=e.chart.navigationBindings,o=i.activeAnnotation;n&&n.click.call(e,t),o!==e?(i.deselectAnnotation(),i.activeAnnotation=e,e.setControlPointsVisibility(!0),fireEvent(i,"showPopup",{annotation:e,formType:"annotation-toolbar",options:i.annotationToFields(e),onSubmit:function(t){var n,o={};"remove"===t.actionType?(i.activeAnnotation=!1,i.chart.removeAnnotation(e)):(i.fieldsToOptions(t.fields,o),i.deselectAnnotation(),n=o.typeOptions,"measure"===e.options.type&&(n.crosshairY.enabled=0!==n.crosshairY.strokeWidth,n.crosshairX.enabled=0!==n.crosshairX.strokeWidth),e.update(o))}})):(i.deselectAnnotation(),fireEvent(i,"closePopup")),t.activeAnnotation=!0}})}NavigationBindings.prototype.utils=bindingsUtils,H.Chart.prototype.initNavigationBindings=function(){var t=this.options;t&&t.navigation&&t.navigation.bindings&&(this.navigationBindings=new NavigationBindings(this,t.navigation),this.navigationBindings.initEvents(),this.navigationBindings.initUpdate())},addEvent(H.Chart,"load",function(){this.initNavigationBindings()}),addEvent(H.Chart,"destroy",function(){this.navigationBindings&&this.navigationBindings.destroy()}),addEvent(NavigationBindings,"deselectButton",function(){this.selectedButtonElement=null}),addEvent(H.Annotation,"remove",function(){this.chart.navigationBindings&&this.chart.navigationBindings.deselectAnnotation()}),H.Annotation&&(selectableAnnotation(H.Annotation),objectEach(H.Annotation.types,function(t){selectableAnnotation(t)})),H.setOptions({lang:{navigation:{popup:{simpleShapes:"Simple shapes",lines:"Lines",circle:"Circle",rectangle:"Rectangle",label:"Label",shapeOptions:"Shape options",typeOptions:"Details",fill:"Fill",format:"Text",strokeWidth:"Line width",stroke:"Line color",title:"Title",name:"Name",labelOptions:"Label options",labels:"Labels",backgroundColor:"Background color",backgroundColors:"Background colors",borderColor:"Border color",borderRadius:"Border radius",borderWidth:"Border width",style:"Style",padding:"Padding",fontSize:"Font size",color:"Color",height:"Height",shapes:"Shape options"}}},navigation:{bindingsClassName:"highcharts-bindings-container",bindings:{circleAnnotation:{className:"highcharts-circle-annotation",start:function(t){var n=this.chart.pointer.getCoordinates(t),e=this.chart.options.navigation;return this.chart.addAnnotation(merge({langKey:"circle",type:"basicAnnotation",shapes:[{type:"circle",point:{xAxis:0,yAxis:0,x:n.xAxis[0].value,y:n.yAxis[0].value},r:5}]},e.annotationsOptions,e.bindings.circleAnnotation.annotationsOptions))},steps:[function(t,n){var e=n.options.shapes[0].point,i=this.chart.xAxis[0].toPixels(e.x),o=this.chart.yAxis[0].toPixels(e.y),s=this.chart.inverted,a=Math.max(Math.sqrt(Math.pow(s?o-t.chartX:i-t.chartX,2)+Math.pow(s?i-t.chartY:o-t.chartY,2)),5);n.update({shapes:[{r:a}]})}]},rectangleAnnotation:{className:"highcharts-rectangle-annotation",start:function(t){var n=this.chart.pointer.getCoordinates(t),e=this.chart.options.navigation,i=n.xAxis[0].value,o=n.yAxis[0].value;return this.chart.addAnnotation(merge({langKey:"rectangle",type:"basicAnnotation",shapes:[{type:"path",points:[{xAxis:0,yAxis:0,x:i,y:o},{xAxis:0,yAxis:0,x:i,y:o},{xAxis:0,yAxis:0,x:i,y:o},{xAxis:0,yAxis:0,x:i,y:o}]}]},e.annotationsOptions,e.bindings.rectangleAnnotation.annotationsOptions))},steps:[function(t,n){var e=n.options.shapes[0].points,i=this.chart.pointer.getCoordinates(t),o=i.xAxis[0].value,s=i.yAxis[0].value;e[1].x=o,e[2].x=o,e[2].y=s,e[3].y=s,n.update({shapes:[{points:e}]})}]},labelAnnotation:{className:"highcharts-label-annotation",start:function(t){var n=this.chart.pointer.getCoordinates(t),e=this.chart.options.navigation;return this.chart.addAnnotation(merge({langKey:"label",type:"basicAnnotation",labelOptions:{format:"{y:.2f}"},labels:[{point:{xAxis:0,yAxis:0,x:n.xAxis[0].value,y:n.yAxis[0].value},overflow:"none",crop:!0}]},e.annotationsOptions,e.bindings.labelAnnotation.annotationsOptions))}}},events:{},annotationsOptions:{}}});export default NavigationBindings;