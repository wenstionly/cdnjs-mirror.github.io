"use strict";import Axis from"../parts/Axis.js";import H from"../parts/Globals.js";import Tick from"../parts/Tick.js";import U from"../parts/Utilities.js";var addEvent=U.addEvent,defined=U.defined,erase=U.erase,find=U.find,isArray=U.isArray,isNumber=U.isNumber,merge=U.merge,pick=U.pick,timeUnits=U.timeUnits,wrap=U.wrap,argsToArray=function(t){return Array.prototype.slice.call(t,1)},dateFormat=H.dateFormat,isObject=function(t){return U.isObject(t,!0)},Chart=H.Chart,applyGridOptions=function(t){var i=t.options;i.labels||(i.labels={}),i.labels.align=pick(i.labels.align,"center"),t.categories||(i.showLastLabel=!1),t.labelRotation=0,i.labels.rotation=0};Axis.prototype.getMaxLabelDimensions=function(t,i){var e={width:0,height:0};return i.forEach(function(i){var s,n=t[i],r=0,o=0;isObject(n)&&(r=(s=isObject(n.label)?n.label:{}).getBBox?s.getBBox().height:0,s.textStr&&!isNumber(s.textPxLength)&&(s.textPxLength=s.getBBox().width),o=isNumber(s.textPxLength)?Math.round(s.textPxLength):0,e.height=Math.max(r,e.height),e.width=Math.max(o,e.width))}),e},H.dateFormats.W=function(t){var i=new this.Date(t),e=(this.get("Day",i)+6)%7,s=new this.Date(i.valueOf());this.set("Date",s,this.get("Date",i)-e+3);var n=new this.Date(this.get("FullYear",s),0,1);return 4!==this.get("Day",n)&&(this.set("Month",i,0),this.set("Date",i,1+(11-this.get("Day",n))%7)),(1+Math.floor((s.valueOf()-n.valueOf())/6048e5)).toString()},H.dateFormats.E=function(t){return dateFormat("%a",t,!0).charAt(0)},addEvent(Chart,"afterSetChartSize",function(){this.axes.forEach(function(t){(t.grid&&t.grid.columns||[]).forEach(function(t){t.setAxisSize(),t.setAxisTranslation()})})}),addEvent(Tick,"afterGetLabelPosition",function(t){var i,e,s,n,r,o,a,d=this.label,h=this.axis,l=h.reversed,c=h.chart,f=h.options.grid||{},u=h.options.labels,g=u.align,m=GridAxis.Side[h.side],p=t.tickmarkOffset,x=h.tickPositions,k=this.pos-p,b=isNumber(x[t.index+1])?x[t.index+1]-p:h.max+p,v=h.tickSize("tick"),A=v?v[0]:0,P=v?v[1]/2:0;!0===f.enabled&&("top"===m?r=(n=h.top+h.offset)-A:"bottom"===m?n=(r=c.chartHeight-h.bottom+h.offset)+A:(n=h.top+h.len-h.translate(l?b:k),r=h.top+h.len-h.translate(l?k:b)),"right"===m?a=(o=c.chartWidth-h.right+h.offset)+A:"left"===m?o=(a=h.left+h.offset)-A:(o=Math.round(h.left+h.translate(l?b:k))-P,a=Math.round(h.left+h.translate(l?k:b))-P),this.slotWidth=a-o,t.pos.x="left"===g?o:"right"===g?a:o+(a-o)/2,t.pos.y=r+(n-r)/2,e=c.renderer.fontMetrics(u.style.fontSize,d.element),i=d.getBBox().height,u.useHTML?t.pos.y+=e.b+-i/2:(s=Math.round(i/e.h),t.pos.y+=(e.b-(e.h-e.f))/2+-(s-1)*e.h/2),t.pos.x+=h.horiz&&u.x||0)});var GridAxisAdditions=function(){function t(t){this.axis=t}return t.prototype.isOuterAxis=function(){var t=this.axis,i=t.chart,e=t.grid.columnIndex,s=t.linkedParent&&t.linkedParent.grid.columns||t.grid.columns,n=e?t.linkedParent:t,r=-1,o=0;return i[t.coll].forEach(function(i,e){i.side!==t.side||i.options.isInternal||(o=e,i===n&&(r=e))}),o===r&&(!isNumber(e)||s.length===e)},t}(),GridAxis=function(){function t(){}return t.compose=function(i){Axis.keepProps.push("grid"),wrap(i.prototype,"unsquish",t.wrapUnsquish),addEvent(i,"init",t.onInit),addEvent(i,"afterGetOffset",t.onAfterGetOffset),addEvent(i,"afterGetTitlePosition",t.onAfterGetTitlePosition),addEvent(i,"afterInit",t.onAfterInit),addEvent(i,"afterRender",t.onAfterRender),addEvent(i,"afterSetAxisTranslation",t.onAfterSetAxisTranslation),addEvent(i,"afterSetOptions",t.onAfterSetOptions),addEvent(i,"afterSetOptions",t.onAfterSetOptions2),addEvent(i,"afterSetScale",t.onAfterSetScale),addEvent(i,"afterTickSize",t.onAfterTickSize),addEvent(i,"trimTicks",t.onTrimTicks),addEvent(i,"destroy",t.onDestroy)},t.onAfterGetOffset=function(){var t=this.grid;(t&&t.columns||[]).forEach(function(t){t.getOffset()})},t.onAfterGetTitlePosition=function(i){if(!0===(this.options.grid||{}).enabled){var e=this.axisTitle,s=this.height,n=this.horiz,r=this.left,o=this.offset,a=this.opposite,d=this.options.title,h=void 0===d?{}:d,l=this.top,c=this.width,f=this.tickSize(),u=e&&e.getBBox().width,g=h.x||0,m=h.y||0,p=pick(h.margin,n?5:10),x=this.chart.renderer.fontMetrics(h.style&&h.style.fontSize,e).f,k=(n?l+s:r)+(n?1:-1)*(a?-1:1)*(f?f[0]/2:0)+(this.side===t.Side.bottom?x:0);i.titlePosition.x=n?r-u/2-p+g:k+(a?c:0)+o+g,i.titlePosition.y=n?k-(a?s:0)+(a?x:-x)/2+o+m:l-p+m}},t.onAfterInit=function(){var t=this.chart,i=this.options.grid,e=void 0===i?{}:i,s=this.userOptions;if(e.enabled&&(applyGridOptions(this),wrap(this,"labelFormatter",function(t){var i=this.axis,e=this.value,s=i.tickPositions,n=(i.isLinked?i.linkedParent:i).series[0],r=e===s[0],o=e===s[s.length-1],a=n&&find(n.options.data,function(t){return t[i.isXAxis?"x":"y"]===e});return this.isFirst=r,this.isLast=o,this.point=a,t.call(this)})),e.columns)for(var n=this.grid.columns=[],r=this.grid.columnIndex=0;++r<e.columns.length;){var o=merge(s,e.columns[e.columns.length-r-1],{linkedTo:0,type:"category"});delete o.grid.columns;var a=new Axis(this.chart,o);a.grid.isColumn=!0,a.grid.columnIndex=r,erase(t.axes,a),erase(t[this.coll],a),n.push(a)}},t.onAfterRender=function(){var i=this.grid,e=this.options,s=this.chart.renderer;if(!0===(e.grid||{}).enabled){if(this.maxLabelDimensions=this.getMaxLabelDimensions(this.ticks,this.tickPositions),this.rightWall&&this.rightWall.destroy(),this.grid&&this.grid.isOuterAxis()&&this.axisLine){var n=e.lineWidth;if(n){var r=this.getLinePath(n),o=r[0],a=r[1],d=((this.tickSize("tick")||[1])[0]-1)*(this.side===t.Side.top||this.side===t.Side.left?-1:1);"M"===o[0]&&"L"===a[0]&&(this.horiz?(o[2]+=d,a[2]+=d):(o[1]+=d,a[1]+=d)),this.grid.axisLineExtra?this.grid.axisLineExtra.animate({d:r}):(this.grid.axisLineExtra=s.path(r).attr({zIndex:7}).addClass("highcharts-axis-line").add(this.axisGroup),s.styledMode||this.grid.axisLineExtra.attr({stroke:e.lineColor,"stroke-width":n})),this.axisLine[this.showAxis?"show":"hide"](!0)}}(i&&i.columns||[]).forEach(function(t){t.render()})}},t.onAfterSetAxisTranslation=function(){var t=this.tickPositions&&this.tickPositions.info,i=this.options,e=i.grid||{},s=this.userOptions.labels||{};this.horiz&&(!0===e.enabled&&this.series.forEach(function(t){t.options.pointRange=0}),t&&i.dateTimeLabelFormats&&i.labels&&!defined(s.align)&&(!1===i.dateTimeLabelFormats[t.unitName].range||t.count>1)&&(i.labels.align="left",defined(s.x)||(i.labels.x=3)))},t.onAfterSetOptions=function(t){var i,e=this.options,s=t.userOptions,n=e&&isObject(e.grid)?e.grid:{};!0===n.enabled&&(i=merge(!0,{className:"highcharts-grid-axis "+(s.className||""),dateTimeLabelFormats:{hour:{list:["%H:%M","%H"]},day:{list:["%A, %e. %B","%a, %e. %b","%E"]},week:{list:["Week %W","W%W"]},month:{list:["%B","%b","%o"]}},grid:{borderWidth:1},labels:{padding:2,style:{fontSize:"13px"}},margin:0,title:{text:null,reserveSpace:!1,rotation:0},units:[["millisecond",[1,10,100]],["second",[1,10]],["minute",[1,5,15]],["hour",[1,6]],["day",[1]],["week",[1]],["month",[1]],["year",null]]},s),"xAxis"===this.coll&&(defined(s.linkedTo)&&!defined(s.tickPixelInterval)&&(i.tickPixelInterval=350),defined(s.tickPixelInterval)||!defined(s.linkedTo)||defined(s.tickPositioner)||defined(s.tickInterval)||(i.tickPositioner=function(t,e){var s=this.linkedParent&&this.linkedParent.tickPositions&&this.linkedParent.tickPositions.info;if(s){var n,r,o,a,d,h=i.units;for(a=0;a<h.length;a++)if(h[a][0]===s.unitName){n=a;break}return h[n+1]?(o=h[n+1][0],r=(h[n+1][1]||[1])[0]):"year"===s.unitName&&(o="year",r=10*s.count),d=timeUnits[o],this.tickInterval=d*r,this.getTimeTicks({unitRange:d,count:r,unitName:o},t,e,this.options.startOfWeek)}})),merge(!0,this.options,i),this.horiz&&(e.minPadding=pick(s.minPadding,0),e.maxPadding=pick(s.maxPadding,0)),isNumber(e.grid.borderWidth)&&(e.tickWidth=e.lineWidth=n.borderWidth))},t.onAfterSetOptions2=function(t){var i=t.userOptions,e=i&&i.grid||{},s=e.columns;e.enabled&&s&&merge(!0,this.options,s[s.length-1])},t.onAfterSetScale=function(){(this.grid.columns||[]).forEach(function(t){t.setScale()})},t.onAfterTickSize=function(t){var i=Axis.defaultLeftAxisOptions,e=this.horiz,s=this.maxLabelDimensions,n=this.options.grid,r=void 0===n?{}:n;if(r.enabled&&s){var o=2*Math.abs(i.labels.x),a=e?r.cellHeight||o+s.height:o+s.width;isArray(t.tickSize)?t.tickSize[0]=a:t.tickSize=[a,0]}},t.onDestroy=function(t){var i=this.grid;(i.columns||[]).forEach(function(i){i.destroy(t.keepEvents)}),i.columns=void 0},t.onInit=function(t){var i=t.userOptions||{},e=i.grid||{};e.enabled&&defined(e.borderColor)&&(i.tickColor=i.lineColor=e.borderColor),this.grid||(this.grid=new GridAxisAdditions(this))},t.onTrimTicks=function(){var t=this.options,i=t.grid||{},e=this.categories,s=this.tickPositions,n=s[0],r=s[s.length-1],o=this.linkedParent&&this.linkedParent.min,a=this.linkedParent&&this.linkedParent.max,d=o||this.min,h=a||this.max,l=this.tickInterval,c=n<d&&n+l>d,f=r>h&&r-l<h;!0!==i.enabled||e||!this.horiz&&!this.isLinked||(c&&!t.startOnTick&&(s[0]=d),f&&!t.endOnTick&&(s[s.length-1]=h))},t.wrapUnsquish=function(t){var i=this.options.grid;return!0===(void 0===i?{}:i).enabled&&this.categories?this.tickInterval:t.apply(this,argsToArray(arguments))},t}();!function(t){!function(t){t[t.top=0]="top",t[t.right=1]="right",t[t.bottom=2]="bottom",t[t.left=3]="left"}(t.Side||(t.Side={}))}(GridAxis||(GridAxis={})),GridAxis.compose(Axis);export default GridAxis;