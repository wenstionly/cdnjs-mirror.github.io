"use strict";import H from"../parts/Globals.js";import U from"../parts/Utilities.js";var addEvent=U.addEvent,animObject=U.animObject,extend=U.extend,fireEvent=U.fireEvent,format=U.format,isNumber=U.isNumber,pick=U.pick,syncTimeout=U.syncTimeout;import"../parts/Chart.js";import"../parts/Series.js";var labelDistance=3,Series=H.Series,SVGRenderer=H.SVGRenderer,Chart=H.Chart;function ccw(t,e,r,i,o,a){var n=(a-e)*(r-t)-(i-e)*(o-t);return n>0||!(n<0)}function intersectLine(t,e,r,i,o,a,n,h){return ccw(t,e,o,a,n,h)!==ccw(r,i,o,a,n,h)&&ccw(t,e,r,i,o,a)!==ccw(t,e,r,i,n,h)}function boxIntersectLine(t,e,r,i,o,a,n,h){return intersectLine(t,e,t+r,e,o,a,n,h)||intersectLine(t+r,e,t+r,e+i,o,a,n,h)||intersectLine(t,e+i,t+r,e+i,o,a,n,h)||intersectLine(t,e,t,e+i,o,a,n,h)}function drawLabels(t){if(this.renderer){var e=this,r=animObject(e.renderer.globalAnimation).duration;e.labelSeries=[],e.labelSeriesMaxSum=0,U.clearTimeout(e.seriesLabelTimer),e.series.forEach(function(i){var o=i.options.label,a=i.labelBySeries,n=a&&a.closest;o.enabled&&i.visible&&(i.graph||i.area)&&!i.isSeriesBoosting&&(e.labelSeries.push(i),o.minFontSize&&o.maxFontSize&&(i.sum=i.yData.reduce(function(t,e){return(t||0)+(e||0)},0),e.labelSeriesMaxSum=Math.max(e.labelSeriesMaxSum,i.sum)),"load"===t.type&&(r=Math.max(r,animObject(i.options.animation).duration)),n&&(void 0!==n[0].plotX?a.animate({x:n[0].plotX+n[1],y:n[0].plotY+n[2]}):a.attr({opacity:0})))}),e.seriesLabelTimer=syncTimeout(function(){e.series&&e.labelSeries&&e.drawSeriesLabels()},e.renderer.forExport||!r?0:r)}}H.setOptions({plotOptions:{series:{label:{enabled:!0,connectorAllowed:!1,connectorNeighbourDistance:24,format:void 0,formatter:void 0,minFontSize:null,maxFontSize:null,onArea:null,style:{fontWeight:"bold"},boxesToAvoid:[]}}}}),SVGRenderer.prototype.symbols.connector=function(t,e,r,i,o){var a,n,h=o&&o.anchorX,s=o&&o.anchorY,c=r/2;return isNumber(h)&&isNumber(s)&&(a=[["M",h,s]],(n=e-s)<0&&(n=-i-n),n<r&&(c=h<t+r/2?n:r-n),s>e+i?a.push(["L",t+c,e+i]):s<e?a.push(["L",t+c,e]):h<t?a.push(["L",t,e+i/2]):h>t+r&&a.push(["L",t+r,e+i/2])),a||[]},Series.prototype.getPointsOnGraph=function(){if(this.xAxis||this.yAxis){var t,e,r,i,o,a,n,h,s,c,l=this.points,p=[],d=this.graph||this.area,b=d.element,u=this.chart.inverted,x=this.xAxis,f=this.yAxis,m=u?f.pos:x.pos,g=u?x.pos:f.pos,y=pick(this.options.label.onArea,!!this.area),w=f.getThreshold(this.options.threshold),Y={};if(this.getPointSpline&&b.getPointAtLength&&!y&&l.length<this.chart.plotSizeX/16){for(d.toD&&(c=d.attr("d"),d.attr({d:d.toD})),n=b.getTotalLength(),r=0;r<n;r+=16)X({chartX:m+(t=b.getPointAtLength(r)).x,chartY:g+t.y,plotX:t.x,plotY:t.y});c&&d.attr({d:c}),(t=l[l.length-1]).chartX=m+t.plotX,t.chartY=g+t.plotY,X(t)}else for(n=l.length,r=0;r<n;r+=1){if(t=l[r],e=l[r-1],t.chartX=m+t.plotX,t.chartY=g+t.plotY,y&&(t.chartCenterY=g+(t.plotY+pick(t.yBottom,w))/2),r>0&&(i=Math.abs(t.chartX-e.chartX),o=Math.abs(t.chartY-e.chartY),(a=Math.max(i,o))>16))for(h=Math.ceil(a/16),s=1;s<h;s+=1)X({chartX:e.chartX+(t.chartX-e.chartX)*(s/h),chartY:e.chartY+(t.chartY-e.chartY)*(s/h),chartCenterY:e.chartCenterY+(t.chartCenterY-e.chartCenterY)*(s/h),plotX:e.plotX+(t.plotX-e.plotX)*(s/h),plotY:e.plotY+(t.plotY-e.plotY)*(s/h)});isNumber(t.plotY)&&X(t)}return p}function X(t){var e=Math.round(t.plotX/8)+","+Math.round(t.plotY/8);Y[e]||(Y[e]=1,p.push(t))}},Series.prototype.labelFontSize=function(t,e){return t+this.sum/this.chart.labelSeriesMaxSum*(e-t)+"px"},Series.prototype.checkClearPoint=function(t,e,r,i){var o,a,n,h,s,c,l,p,d,b,u,x=Number.MAX_VALUE,f=Number.MAX_VALUE,m=pick(this.options.label.onArea,!!this.area),g=m||this.options.label.connectorAllowed,y=this.chart;for(p=0;p<y.boxesToAvoid.length;p+=1)if(b=y.boxesToAvoid[p],!((u={left:t,right:t+r.width,top:e,bottom:e+r.height}).left>b.right||u.right<b.left||u.top>b.bottom||u.bottom<b.top))return!1;for(p=0;p<y.series.length;p+=1)if(h=(n=y.series[p]).interpolatedPoints,n.visible&&h){for(d=1;d<h.length;d+=1){if(h[d].chartX>=t-16&&h[d-1].chartX<=t+r.width+16){if(boxIntersectLine(t,e,r.width,r.height,h[d-1].chartX,h[d-1].chartY,h[d].chartX,h[d].chartY))return!1;this===n&&!s&&i&&(s=boxIntersectLine(t-16,e-16,r.width+32,r.height+32,h[d-1].chartX,h[d-1].chartY,h[d].chartX,h[d].chartY))}!g&&!s||this===n&&!m||(c=t+r.width/2-h[d].chartX,l=e+r.height/2-h[d].chartY,x=Math.min(x,c*c+l*l))}if(!m&&g&&this===n&&(i&&!s||x<Math.pow(this.options.label.connectorNeighbourDistance,2))){for(d=1;d<h.length;d+=1)(o=Math.min(Math.pow(t+r.width/2-h[d].chartX,2)+Math.pow(e+r.height/2-h[d].chartY,2),Math.pow(t-h[d].chartX,2)+Math.pow(e-h[d].chartY,2),Math.pow(t+r.width-h[d].chartX,2)+Math.pow(e-h[d].chartY,2),Math.pow(t+r.width-h[d].chartX,2)+Math.pow(e+r.height-h[d].chartY,2),Math.pow(t-h[d].chartX,2)+Math.pow(e+r.height-h[d].chartY,2)))<f&&(f=o,a=h[d]);s=!0}}return!(i&&!s)&&{x:t,y:e,weight:function(t,e){return t-e}(x,a?f:0),connectorPoint:a}},Chart.prototype.drawSeriesLabels=function(){var t=this,e=this.labelSeries;t.boxesToAvoid=[],e.forEach(function(e){e.interpolatedPoints=e.getPointsOnGraph(),(e.options.label.boxesToAvoid||[]).forEach(function(e){t.boxesToAvoid.push(e)})}),t.series.forEach(function(e){var r=e.options.label;if(r&&(e.xAxis||e.yAxis)){var i,o,a,n,h,s,c,l,p,d=[],b=t.inverted,u=b?e.yAxis.pos:e.xAxis.pos,x=b?e.xAxis.pos:e.yAxis.pos,f=t.inverted?e.yAxis.len:e.xAxis.len,m=t.inverted?e.xAxis.len:e.yAxis.len,g=e.interpolatedPoints,y=pick(r.onArea,!!e.area),w=e.labelBySeries,Y=!w,X=r.minFontSize,v=r.maxFontSize,S="highcharts-color-"+pick(e.colorIndex,"none");if(y&&!b&&(c=[e.xAxis.toPixels(e.xData[0]),e.xAxis.toPixels(e.xData[e.xData.length-1])],l=Math.min.apply(Math,c),p=Math.max.apply(Math,c)),e.visible&&!e.isSeriesBoosting&&g){if(!w){var M=e.name;"string"==typeof r.format?M=format(r.format,e,t):r.formatter&&(M=r.formatter.call(e)),e.labelBySeries=w=t.renderer.label(M,0,-9999,"connector").addClass("highcharts-series-label highcharts-series-label-"+e.index+" "+(e.options.className||"")+S),t.renderer.styledMode||(w.css(extend({color:y?t.renderer.getContrast(e.color):e.color},r.style||{})),w.attr({opacity:t.renderer.forExport?1:0,stroke:e.color,"stroke-width":1})),X&&v&&w.css({fontSize:e.labelFontSize(X,v)}),w.attr({padding:0,zIndex:3}).add()}for((i=w.getBBox()).width=Math.round(i.width),h=g.length-1;h>0;h-=1)y?(D(o=g[h].chartX-i.width/2,a=g[h].chartCenterY-i.height/2,i)&&(s=e.checkClearPoint(o,a,i)),s&&d.push(s)):(D(o=g[h].chartX+labelDistance,a=g[h].chartY-i.height-labelDistance,i)&&(s=e.checkClearPoint(o,a,i,!0)),s&&d.push(s),D(o=g[h].chartX+labelDistance,a=g[h].chartY+labelDistance,i)&&(s=e.checkClearPoint(o,a,i,!0)),s&&d.push(s),D(o=g[h].chartX-i.width-labelDistance,a=g[h].chartY+labelDistance,i)&&(s=e.checkClearPoint(o,a,i,!0)),s&&d.push(s),D(o=g[h].chartX-i.width-labelDistance,a=g[h].chartY-i.height-labelDistance,i)&&(s=e.checkClearPoint(o,a,i,!0)),s&&d.push(s));if(r.connectorAllowed&&!d.length&&!y)for(o=u+f-i.width;o>=u;o-=16)for(a=x;a<x+m-i.height;a+=16)(n=e.checkClearPoint(o,a,i,!0))&&d.push(n);if(d.length){d.sort(function(t,e){return e.weight-t.weight}),s=d[0],t.boxesToAvoid.push({left:s.x,right:s.x+i.width,top:s.y,bottom:s.y+i.height});var A=Math.sqrt(Math.pow(Math.abs(s.x-w.x),2),Math.pow(Math.abs(s.y-w.y),2));if(A&&e.labelBySeries){var L={opacity:t.renderer.forExport?1:0,x:s.x,y:s.y},P={opacity:1};A<=10&&(P={x:L.x,y:L.y},L={});var C=void 0;Y&&((C=animObject(e.options.animation)).duration*=.2),e.labelBySeries.attr(extend(L,{anchorX:s.connectorPoint&&s.connectorPoint.plotX+u,anchorY:s.connectorPoint&&s.connectorPoint.plotY+x})).animate(P,C),e.options.kdNow=!0,e.buildKDTree();var k=e.searchPoint({chartX:s.x,chartY:s.y},!0);k&&(w.closest=[k,s.x-(k.plotX||0),s.y-(k.plotY||0)])}}else E()}else E()}function D(t,e,r){var i=Math.max(u,pick(l,-1/0)),o=Math.min(u+f,pick(p,1/0));return t>i&&t<=o-r.width&&e>=x&&e<=x+m-r.height}function E(){w&&(e.labelBySeries=w.destroy())}}),fireEvent(t,"afterDrawSeriesLabels")},addEvent(Chart,"load",drawLabels),addEvent(Chart,"redraw",drawLabels);