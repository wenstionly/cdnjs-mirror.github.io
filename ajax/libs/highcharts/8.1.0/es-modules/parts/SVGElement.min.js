"use strict";import Color from"./Color.js";import H from"./Globals.js";var deg2rad=H.deg2rad,doc=H.doc,hasTouch=H.hasTouch,isFirefox=H.isFirefox,noop=H.noop,svg=H.svg,SVG_NS=H.SVG_NS,win=H.win;import U from"./Utilities.js";var animate=U.animate,animObject=U.animObject,attr=U.attr,createElement=U.createElement,css=U.css,defined=U.defined,erase=U.erase,extend=U.extend,fireEvent=U.fireEvent,inArray=U.inArray,isArray=U.isArray,isFunction=U.isFunction,isNumber=U.isNumber,isString=U.isString,merge=U.merge,objectEach=U.objectEach,pick=U.pick,pInt=U.pInt,stop=U.stop,uniqueKey=U.uniqueKey,SVGElement=function(){function t(){this.element=void 0,this.height=void 0,this.opacity=1,this.renderer=void 0,this.SVG_NS=SVG_NS,this.symbolCustomAttribs=["x","y","width","height","r","start","end","innerR","anchorX","anchorY","rounded"],this.textProps=["color","cursor","direction","fontFamily","fontSize","fontStyle","fontWeight","lineHeight","textAlign","textDecoration","textOutline","textOverflow","width"],this.width=void 0}return t.prototype._defaultGetter=function(t){var e=pick(this[t+"Value"],this[t],this.element?this.element.getAttribute(t):null,0);return/^[\-0-9\.]+$/.test(e)&&(e=parseFloat(e)),e},t.prototype._defaultSetter=function(t,e,i){i.setAttribute(e,t)},t.prototype.add=function(t){var e,i=this.renderer,r=this.element;return t&&(this.parentGroup=t),this.parentInverted=t&&t.inverted,void 0!==this.textStr&&i.buildText(this),this.added=!0,(!t||t.handleZ||this.zIndex)&&(e=this.zIndexSetter()),e||(t?t.element:i.box).appendChild(r),this.onAdd&&this.onAdd(),this},t.prototype.addClass=function(t,e){var i=e?"":this.attr("class")||"";return(t=(t||"").split(/ /g).reduce(function(t,e){return-1===i.indexOf(e)&&t.push(e),t},i?[i]:[]).join(" "))!==i&&this.attr("class",t),this},t.prototype.afterSetters=function(){this.doTransform&&(this.updateTransform(),this.doTransform=!1)},t.prototype.align=function(t,e,i){var r,o,n,s,h,a,d,l={},p=this.renderer,c=p.alignedObjects;return t?(this.alignOptions=t,this.alignByTranslate=e,i&&!isString(i)||(this.alignTo=h=i||"renderer",erase(c,this),c.push(this),i=void 0)):(t=this.alignOptions,e=this.alignByTranslate,h=this.alignTo),i=pick(i,p[h],p),r=t.align,o=t.verticalAlign,n=(i.x||0)+(t.x||0),s=(i.y||0)+(t.y||0),"right"===r?a=1:"center"===r&&(a=2),a&&(n+=(i.width-(t.width||0))/a),l[e?"translateX":"x"]=Math.round(n),"bottom"===o?d=1:"middle"===o&&(d=2),d&&(s+=(i.height-(t.height||0))/d),l[e?"translateY":"y"]=Math.round(s),this[this.placed?"animate":"attr"](l),this.placed=!0,this.alignAttr=l,this},t.prototype.alignSetter=function(t){var e={left:"start",center:"middle",right:"end"};e[t]&&(this.alignValue=t,this.element.setAttribute("text-anchor",e[t]))},t.prototype.animate=function(t,e,i){var r=animObject(pick(e,this.renderer.globalAnimation,!0));return pick(doc.hidden,doc.msHidden,doc.webkitHidden,!1)&&(r.duration=0),0!==r.duration?(i&&(r.complete=i),animate(this,t,r)):(this.attr(t,void 0,i),objectEach(t,function(t,e){r.step&&r.step.call(this,t,{prop:e,pos:1})},this)),this},t.prototype.applyTextOutline=function(t){var e,i,r,o,n=this.element;if(-1!==t.indexOf("contrast")&&(t=t.replace(/contrast/g,this.renderer.getContrast(n.style.fill))),t=t.split(" "),i=t[t.length-1],(r=t[0])&&"none"!==r&&H.svg){this.fakeTS=!0,e=[].slice.call(n.getElementsByTagName("tspan")),this.ySetter=this.xSetter,r=r.replace(/(^[\d\.]+)(.*?)$/g,function(t,e,i){return 2*e+i}),this.removeTextOutline(e);var s=!!n.textContent&&/^[\u0591-\u065F\u066A-\u07FF\uFB1D-\uFDFD\uFE70-\uFEFC]/.test(n.textContent);if(o=n.firstChild,e.forEach(function(t,e){var h;0===e&&(t.setAttribute("x",n.getAttribute("x")),e=n.getAttribute("y"),t.setAttribute("y",e||0),null===e&&n.setAttribute("y",0)),h=t.cloneNode(!0),attr(s&&!isFirefox?t:h,{class:"highcharts-text-outline",fill:i,stroke:i,"stroke-width":r,"stroke-linejoin":"round"}),n.insertBefore(h,o)}),s&&isFirefox&&e[0]){var h=e[0].cloneNode(!0);h.textContent=" ",n.insertBefore(h,o)}}},t.prototype.attr=function(t,e,i,r){var o,n,s,h,a=this.element,d=this,l=this.symbolCustomAttribs;return"string"==typeof t&&void 0!==e&&(o=t,(t={})[o]=e),"string"==typeof t?d=(this[t+"Getter"]||this._defaultGetter).call(this,t,a):(objectEach(t,function(e,i){s=!1,r||stop(this,i),this.symbolName&&-1!==inArray(i,l)&&(n||(this.symbolAttr(t),n=!0),s=!0),!this.rotation||"x"!==i&&"y"!==i||(this.doTransform=!0),s||((h=this[i+"Setter"]||this._defaultSetter).call(this,e,i,a),!this.styledMode&&this.shadows&&/^(width|height|visibility|x|y|d|transform|cx|cy|r)$/.test(i)&&this.updateShadows(i,e,h))},this),this.afterSetters()),i&&i.call(this),d},t.prototype.clip=function(t){return this.attr("clip-path",t?"url("+this.renderer.url+"#"+t.id+")":"none")},t.prototype.crisp=function(t,e){var i;return e=e||t.strokeWidth||0,i=Math.round(e)%2/2,t.x=Math.floor(t.x||this.x||0)+i,t.y=Math.floor(t.y||this.y||0)+i,t.width=Math.floor((t.width||this.width||0)-2*i),t.height=Math.floor((t.height||this.height||0)-2*i),defined(t.strokeWidth)&&(t.strokeWidth=e),t},t.prototype.complexColor=function(t,e,i){var r,o,n,s,h,a,d,l,p,c,u,f=this.renderer,y=[];fireEvent(this.renderer,"complexColor",{args:arguments},function(){if(t.radialGradient?o="radialGradient":t.linearGradient&&(o="linearGradient"),o){if(n=t[o],h=f.gradients,a=t.stops,p=i.radialReference,isArray(n)&&(t[o]=n={x1:n[0],y1:n[1],x2:n[2],y2:n[3],gradientUnits:"userSpaceOnUse"}),"radialGradient"===o&&p&&!defined(n.gradientUnits)&&(s=n,n=merge(n,f.getRadialAttr(p,s),{gradientUnits:"userSpaceOnUse"})),objectEach(n,function(t,e){"id"!==e&&y.push(e,t)}),objectEach(a,function(t){y.push(t)}),y=y.join(","),h[y])c=h[y].attr("id");else{n.id=c=uniqueKey();var m=h[y]=f.createElement(o).attr(n).add(f.defs);m.radAttr=s,m.stops=[],a.forEach(function(t){var e;0===t[1].indexOf("rgba")?(r=Color.parse(t[1]),d=r.get("rgb"),l=r.get("a")):(d=t[1],l=1),e=f.createElement("stop").attr({offset:t[0],"stop-color":d,"stop-opacity":l}).add(m),m.stops.push(e)})}u="url("+f.url+"#"+c+")",i.setAttribute(e,u),i.gradient=y,t.toString=function(){return u}}})},t.prototype.css=function(t){var e,i,r=this.styles,o={},n=this.element,s="",h=!r,a=["textOutline","textOverflow","width"];return t&&t.color&&(t.fill=t.color),r&&objectEach(t,function(t,e){r&&r[e]!==t&&(o[e]=t,h=!0)}),h&&(r&&(t=extend(r,o)),t&&(null===t.width||"auto"===t.width?delete this.textWidth:"text"===n.nodeName.toLowerCase()&&t.width&&(e=this.textWidth=pInt(t.width))),this.styles=t,e&&!svg&&this.renderer.forExport&&delete t.width,n.namespaceURI===this.SVG_NS?(i=function(t,e){return"-"+e.toLowerCase()},objectEach(t,function(t,e){-1===a.indexOf(e)&&(s+=e.replace(/([A-Z])/g,i)+":"+t+";")}),s&&attr(n,"style",s)):css(n,t),this.added&&("text"===this.element.nodeName&&this.renderer.buildText(this),t&&t.textOutline&&this.applyTextOutline(t.textOutline))),this},t.prototype.dashstyleSetter=function(t){var e,i=this["stroke-width"];if("inherit"===i&&(i=1),t=t&&t.toLowerCase()){var r=t.replace("shortdashdotdot","3,1,1,1,1,1,").replace("shortdashdot","3,1,1,1").replace("shortdot","1,1,").replace("shortdash","3,1,").replace("longdash","8,3,").replace(/dot/g,"1,3,").replace("dash","4,3,").replace(/,$/,"").split(",");for(e=r.length;e--;)r[e]=""+pInt(r[e])*pick(i,NaN);t=r.join(",").replace(/NaN/g,"none"),this.element.setAttribute("stroke-dasharray",t)}},t.prototype.destroy=function(){var t,e,i=this,r=i.element||{},o=i.renderer,n=o.isSVG&&"SPAN"===r.nodeName&&i.parentGroup||void 0,s=r.ownerSVGElement;if(r.onclick=r.onmouseout=r.onmouseover=r.onmousemove=r.point=null,stop(i),i.clipPath&&s){var h=i.clipPath;[].forEach.call(s.querySelectorAll("[clip-path],[CLIP-PATH]"),function(t){t.getAttribute("clip-path").indexOf(h.element.id)>-1&&t.removeAttribute("clip-path")}),i.clipPath=h.destroy()}if(i.stops){for(e=0;e<i.stops.length;e++)i.stops[e].destroy();i.stops.length=0,i.stops=void 0}for(i.safeRemoveChild(r),o.styledMode||i.destroyShadows();n&&n.div&&0===n.div.childNodes.length;)t=n.parentGroup,i.safeRemoveChild(n.div),delete n.div,n=t;i.alignTo&&erase(o.alignedObjects,i),objectEach(i,function(t,e){i[e]&&i[e].parentGroup===i&&i[e].destroy&&i[e].destroy(),delete i[e]})},t.prototype.destroyShadows=function(){(this.shadows||[]).forEach(function(t){this.safeRemoveChild(t)},this),this.shadows=void 0},t.prototype.destroyTextPath=function(t,e){var i,r=t.getElementsByTagName("text")[0];if(r){if(r.removeAttribute("dx"),r.removeAttribute("dy"),e.element.setAttribute("id",""),this.textPathWrapper&&r.getElementsByTagName("textPath").length){for(i=this.textPathWrapper.element.childNodes;i.length;)r.appendChild(i[0]);r.removeChild(this.textPathWrapper.element)}}else(t.getAttribute("dx")||t.getAttribute("dy"))&&(t.removeAttribute("dx"),t.removeAttribute("dy"));this.textPathWrapper&&(this.textPathWrapper=this.textPathWrapper.destroy())},t.prototype.dSetter=function(t,e,i){isArray(t)&&("string"==typeof t[0]&&(t=this.renderer.pathToSegments(t)),this.pathArray=t,t=t.reduce(function(t,e,i){return e&&e.join?(i?t+" ":"")+e.join(" "):(e||"").toString()},"")),/(NaN| {2}|^$)/.test(t)&&(t="M 0 0"),this[e]!==t&&(i.setAttribute(e,t),this[e]=t)},t.prototype.fadeOut=function(t){var e=this;e.animate({opacity:0},{duration:pick(t,150),complete:function(){e.attr({y:-9999}).hide()}})},t.prototype.fillSetter=function(t,e,i){"string"==typeof t?i.setAttribute(e,t):t&&this.complexColor(t,e,i)},t.prototype.getBBox=function(e,i){var r,o,n,s,h,a,d=this.renderer,l=this.element,p=this.styles,c=this.textStr,u=d.cache,f=d.cacheKeys,y=l.namespaceURI===this.SVG_NS,m=pick(i,this.rotation,0);if(s=d.styledMode?l&&t.prototype.getStyle.call(l,"font-size"):p&&p.fontSize,defined(c)&&(-1===(a=c.toString()).indexOf("<")&&(a=a.replace(/[0-9]/g,"0")),a+=["",m,s,this.textWidth,p&&p.textOverflow,p&&p.fontWeight].join(",")),a&&!e&&(r=u[a]),!r){if(y||d.forExport){try{h=this.fakeTS&&function(t){[].forEach.call(l.querySelectorAll(".highcharts-text-outline"),function(e){e.style.display=t})},isFunction(h)&&h("none"),r=l.getBBox?extend({},l.getBBox()):{width:l.offsetWidth,height:l.offsetHeight},isFunction(h)&&h("")}catch(t){}(!r||r.width<0)&&(r={width:0,height:0})}else r=this.htmlGetBBox();if(d.isSVG&&(o=r.width,n=r.height,y&&(r.height=n={"11px,17":14,"13px,20":16}[p&&p.fontSize+","+Math.round(n)]||n),m)){var g=m*deg2rad;r.width=Math.abs(n*Math.sin(g))+Math.abs(o*Math.cos(g)),r.height=Math.abs(n*Math.cos(g))+Math.abs(o*Math.sin(g))}if(a&&r.height>0){for(;f.length>250;)delete u[f.shift()];u[a]||f.push(a),u[a]=r}}return r},t.prototype.getStyle=function(t){return win.getComputedStyle(this.element||this,"").getPropertyValue(t)},t.prototype.hasClass=function(t){return-1!==(""+this.attr("class")).split(" ").indexOf(t)},t.prototype.hide=function(t){return t?this.attr({y:-9999}):this.attr({visibility:"hidden"}),this},t.prototype.htmlGetBBox=function(){return{height:0,width:0,x:0,y:0}},t.prototype.init=function(t,e){this.element="span"===e?createElement(e):doc.createElementNS(this.SVG_NS,e),this.renderer=t,fireEvent(this,"afterInit")},t.prototype.invert=function(t){return this.inverted=t,this.updateTransform(),this},t.prototype.on=function(t,e){var i,r,o=this.element;return hasTouch&&"click"===t?(o.ontouchstart=function(t){i={clientX:t.touches[0].clientX,clientY:t.touches[0].clientY}},o.ontouchend=function(t){!!i.clientX&&Math.sqrt(Math.pow(i.clientX-t.changedTouches[0].clientX,2)+Math.pow(i.clientY-t.changedTouches[0].clientY,2))>=4||e.call(o,t),r=!0,t.preventDefault()},o.onclick=function(t){r||e.call(o,t)}):o["on"+t]=e,this},t.prototype.opacitySetter=function(t,e,i){this[e]=t,i.setAttribute(e,t)},t.prototype.removeClass=function(t){return this.attr("class",(""+this.attr("class")).replace(isString(t)?new RegExp(" ?"+t+" ?"):t,""))},t.prototype.removeTextOutline=function(t){for(var e,i=t.length;i--;)"highcharts-text-outline"===(e=t[i]).getAttribute("class")&&erase(t,this.element.removeChild(e))},t.prototype.safeRemoveChild=function(t){var e=t.parentNode;e&&e.removeChild(t)},t.prototype.setRadialReference=function(t){var e=this.element.gradient&&this.renderer.gradients[this.element.gradient];return this.element.radialReference=t,e&&e.radAttr&&e.animate(this.renderer.getRadialAttr(t,e.radAttr)),this},t.prototype.setTextPath=function(t,e){var i,r,o,n,s=this.element,h={textAnchor:"text-anchor"},a=!1,d=this.textPathWrapper,l=!d;if(i=(e=merge(!0,{enabled:!0,attributes:{dy:-5,startOffset:"50%",textAnchor:"middle"}},e)).attributes,t&&e&&e.enabled){if(d&&null===d.element.parentNode?(l=!0,d=d.destroy()):d&&this.removeTextOutline.call(d.parentGroup,[].slice.call(s.getElementsByTagName("tspan"))),this.options&&this.options.padding&&(i.dx=-this.options.padding),d||(this.textPathWrapper=d=this.renderer.createElement("textPath"),a=!0),r=d.element,(o=t.element.getAttribute("id"))||t.element.setAttribute("id",o=uniqueKey()),l)for(n=s.getElementsByTagName("tspan");n.length;)n[0].setAttribute("y",0),isNumber(i.dx)&&n[0].setAttribute("x",-i.dx),r.appendChild(n[0]);a&&d&&d.add({element:this.text?this.text.element:s}),r.setAttributeNS("http://www.w3.org/1999/xlink","href",this.renderer.url+"#"+o),defined(i.dy)&&(r.parentNode.setAttribute("dy",i.dy),delete i.dy),defined(i.dx)&&(r.parentNode.setAttribute("dx",i.dx),delete i.dx),objectEach(i,function(t,e){r.setAttribute(h[e]||e,t)}),s.removeAttribute("transform"),this.removeTextOutline.call(d,[].slice.call(s.getElementsByTagName("tspan"))),this.text&&!this.renderer.styledMode&&this.attr({fill:"none","stroke-width":0}),this.updateTransform=noop,this.applyTextOutline=noop}else d&&(delete this.updateTransform,delete this.applyTextOutline,this.destroyTextPath(s,t),this.updateTransform(),this.options&&this.options.rotation&&this.applyTextOutline(this.options.style.textOutline));return this},t.prototype.shadow=function(t,e,i){var r,o,n,s,h,a,d=[],l=this.element,p=!1,c=this.oldShadowOptions,u={color:"#000000",offsetX:1,offsetY:1,opacity:.15,width:3};if(!0===t?a=u:"object"==typeof t&&(a=extend(u,t)),a&&(a&&c&&objectEach(a,function(t,e){t!==c[e]&&(p=!0)}),p&&this.destroyShadows(),this.oldShadowOptions=a),a){if(!this.shadows){for(s=a.opacity/a.width,h=this.parentInverted?"translate(-1,-1)":"translate("+a.offsetX+", "+a.offsetY+")",r=1;r<=a.width;r++)o=l.cloneNode(!1),n=2*a.width+1-2*r,attr(o,{stroke:t.color||"#000000","stroke-opacity":s*r,"stroke-width":n,transform:h,fill:"none"}),o.setAttribute("class",(o.getAttribute("class")||"")+" highcharts-shadow"),i&&(attr(o,"height",Math.max(attr(o,"height")-n,0)),o.cutHeight=n),e?e.element.appendChild(o):l.parentNode&&l.parentNode.insertBefore(o,l),d.push(o);this.shadows=d}}else this.destroyShadows();return this},t.prototype.show=function(t){return this.attr({visibility:t?"inherit":"visible"})},t.prototype.strokeSetter=function(e,i,r){this[i]=e,this.stroke&&this["stroke-width"]?(t.prototype.fillSetter.call(this,this.stroke,"stroke",r),r.setAttribute("stroke-width",this["stroke-width"]),this.hasStroke=!0):"stroke-width"===i&&0===e&&this.hasStroke?(r.removeAttribute("stroke"),this.hasStroke=!1):this.renderer.styledMode&&this["stroke-width"]&&(r.setAttribute("stroke-width",this["stroke-width"]),this.hasStroke=!0)},t.prototype.strokeWidth=function(){if(!this.renderer.styledMode)return this["stroke-width"]||0;var t,e=this.getStyle("stroke-width"),i=0;return e.indexOf("px")===e.length-2?i=pInt(e):""!==e&&(t=doc.createElementNS(SVG_NS,"rect"),attr(t,{width:e,"stroke-width":0}),this.element.parentNode.appendChild(t),i=t.getBBox().width,t.parentNode.removeChild(t)),i},t.prototype.symbolAttr=function(t){var e=this;["x","y","r","start","end","width","height","innerR","anchorX","anchorY","clockwise"].forEach(function(i){e[i]=pick(t[i],e[i])}),e.attr({d:e.renderer.symbols[e.symbolName](e.x,e.y,e.width,e.height,e)})},t.prototype.textSetter=function(t){t!==this.textStr&&(delete this.textPxLength,this.textStr=t,this.added&&this.renderer.buildText(this))},t.prototype.titleSetter=function(t){var e=this.element.getElementsByTagName("title")[0];e||(e=doc.createElementNS(this.SVG_NS,"title"),this.element.appendChild(e)),e.firstChild&&e.removeChild(e.firstChild),e.appendChild(doc.createTextNode(String(pick(t,"")).replace(/<[^>]*>/g,"").replace(/&lt;/g,"<").replace(/&gt;/g,">")))},t.prototype.toFront=function(){var t=this.element;return t.parentNode.appendChild(t),this},t.prototype.translate=function(t,e){return this.attr({translateX:t,translateY:e})},t.prototype.updateShadows=function(t,e,i){var r=this.shadows;if(r)for(var o=r.length;o--;)i.call(r[o],"height"===t?Math.max(e-(r[o].cutHeight||0),0):"d"===t?this.d:e,t,r[o])},t.prototype.updateTransform=function(){var t,e=this.translateX||0,i=this.translateY||0,r=this.scaleX,o=this.scaleY,n=this.inverted,s=this.rotation,h=this.matrix,a=this.element;n&&(e+=this.width,i+=this.height),t=["translate("+e+","+i+")"],defined(h)&&t.push("matrix("+h.join(",")+")"),n?t.push("rotate(90) scale(-1,1)"):s&&t.push("rotate("+s+" "+pick(this.rotationOriginX,a.getAttribute("x"),0)+" "+pick(this.rotationOriginY,a.getAttribute("y")||0)+")"),(defined(r)||defined(o))&&t.push("scale("+pick(r,1)+" "+pick(o,1)+")"),t.length&&a.setAttribute("transform",t.join(" "))},t.prototype.visibilitySetter=function(t,e,i){"inherit"===t?i.removeAttribute(e):this[e]!==t&&i.setAttribute(e,t),this[e]=t},t.prototype.xGetter=function(t){return"circle"===this.element.nodeName&&("x"===t?t="cx":"y"===t&&(t="cy")),this._defaultGetter(t)},t.prototype.zIndexSetter=function(t,e){var i,r,o,n,s,h=this.renderer,a=this.parentGroup,d=(a||h).element||h.box,l=this.element,p=!1,c=d===h.box,u=this.added;if(defined(t)?(l.setAttribute("data-z-index",t),t=+t,this[e]===t&&(u=!1)):defined(this[e])&&l.removeAttribute("data-z-index"),this[e]=t,u){for((t=this.zIndex)&&a&&(a.handleZ=!0),s=(i=d.childNodes).length-1;s>=0&&!p;s--)o=(r=i[s]).getAttribute("data-z-index"),n=!defined(o),r!==l&&(t<0&&n&&!c&&!s?(d.insertBefore(l,i[s]),p=!0):(pInt(o)<=t||n&&(!defined(t)||t>=0))&&(d.insertBefore(l,i[s+1]||null),p=!0));p||(d.insertBefore(l,i[c?3:0]||null),p=!0)}return p},t}();SVGElement.prototype["stroke-widthSetter"]=SVGElement.prototype.strokeSetter,SVGElement.prototype.yGetter=SVGElement.prototype.xGetter,SVGElement.prototype.matrixSetter=SVGElement.prototype.rotationOriginXSetter=SVGElement.prototype.rotationOriginYSetter=SVGElement.prototype.rotationSetter=SVGElement.prototype.scaleXSetter=SVGElement.prototype.scaleYSetter=SVGElement.prototype.translateXSetter=SVGElement.prototype.translateYSetter=SVGElement.prototype.verticalAlignSetter=function(t,e){this[e]=t,this.doTransform=!0},H.SVGElement=SVGElement;export default H.SVGElement;