AmCharts.AmExport=AmCharts.Class({construct:function(t,e,r){var o=this;o.DEBUG=!1,o.chart=t,o.canvas=null,o.svgs=[],o.userCFG=e,o.buttonIcon="export.png",o.exportPNG=!0,o.exportPDF=!1,o.exportJPG=!1,o.exportSVG=!1,o.right=0,o.top=0,o.buttonRollOverColor="#EFEFEF",o.textRollOverColor="#CC0000",o.buttonTitle="Save chart as an image",o.buttonAlpha=.75,o.imageFileName="amChart",o.imageBackgroundColor="#FFFFFF",r&&o.init()},toCoordinate:function(t){return void 0===t?"auto":-1!=String(t).indexOf("%")?t:t+"px"},init:function(){var t=this,e=[];t.exportPNG&&e.push("png"),t.exportPDF&&e.push("pdf"),t.exportJPG&&e.push("jpg"),t.exportSVG&&e.push("svg");var r=[];if(1==e.length){var o=e[0];r.push({format:o,iconTitle:t.buttonTitle,icon:t.chart.pathToImages+t.buttonIcon})}else if(1<e.length){for(var a=[],n=0;n<e.length;n++)a.push({format:e[n],title:e[n].toUpperCase()});r.push({onclick:function(){},icon:t.chart.pathToImages+t.buttonIcon,items:a})}var i=t.color;void 0===i&&(i=t.chart.color);var s=t.buttonColor;void 0===s&&(s="transparent"),t.cfg={menuTop:t.toCoordinate(t.top),menuLeft:t.toCoordinate(t.left),menuRight:t.toCoordinate(t.right),menuBottom:t.toCoordinate(t.bottom),menuItems:r,menuItemStyle:{backgroundColor:s,opacity:t.buttonAlpha,rollOverBackgroundColor:t.buttonRollOverColor,color:i,rollOverColor:t.textRollOverColor,paddingTop:"6px",paddingRight:"6px",paddingBottom:"6px",paddingLeft:"6px",marginTop:"0px",marginRight:"0px",marginBottom:"0px",marginLeft:"0px",textAlign:"left",textDecoration:"none",fontFamily:t.chart.fontFamily,fontSize:t.chart.fontSize+"px"},menuItemOutput:{backgroundColor:t.imageBackgroundColor,fileName:t.imageFileName,format:"png",output:"dataurlnewwindow",render:"browser",dpi:90,onclick:function(t,e,r){r.preventDefault(),t.output(e)}},removeImagery:!0},t.processing={buffer:[],drawn:0,timer:0},void 0!==window.canvg&&void 0!==window.RGBColor&&(t.cfg.menuItemOutput.render="canvg"),void 0!==window.saveAs&&(t.cfg.menuItemOutput.output="save"),AmCharts.isIE&&AmCharts.IEversion<10&&(t.cfg.menuItemOutput.output="dataurlnewwindow");var u=t.userCFG;u&&(u.menuItemOutput=AmCharts.extend(t.cfg.menuItemOutput,u.menuItemOutput||{}),u.menuItemStyle=AmCharts.extend(t.cfg.menuItemStyle,u.menuItemStyle||{}),t.cfg=AmCharts.extend(t.cfg,u)),(t.chart.AmExport=t).chart.addListener("rendered",function(){t.setup()}),t.DEBUG&&(window.AmExport=t)},log:function(){console.log("AmExport: ",arguments)},setup:function(){var t=this;10==t.DEBUG&&t.log("SETUP START"),!AmCharts.isIE||AmCharts.isIE&&9<AmCharts.IEversion?(t.generateButtons(),10==t.DEBUG&&t.log("SETUP END")):10==t.DEBUG&&t.log("< IE10 NOT SUPPORTED")},generateBinaryArray:function(t){for(var e,r,o=t.length,a=new Uint8Array(o/4*3|0),n=0,i=0,s=[0,0],u=0,l=0,g=new Uint8Array([62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51]);o--;)255!==(e=g[(r=t.charCodeAt(n++))-43])&&void 0!==e&&(s[1]=s[0],s[0]=r,l=l<<6|e,4===++u&&(a[i++]=l>>>16,61!==s[1]&&(a[i++]=l>>>8),61!==s[0]&&(a[i++]=l),u=0));return a},generateBlob:function(t,e){var r="image/svg+xml"!=e?t.indexOf(",")+1:0,o=t.substring(0,r),a=t,n=new Blob;return-1!=o.indexOf("base64")&&(a=this.generateBinaryArray(t.substring(r))),AmCharts.isIE&&AmCharts.IEversion<10?(n.data=a,n.size=a.length,n.type=e,n.encoding="base64"):n=new Blob([a],{type:e}),n},generatePDF:function(t){var e=this,r={output:function(){return""}},o=e.canvas.toDataURL("image/jpeg"),a=25.4*e.canvas.width/t.dpi,n=25.4*e.canvas.height/t.dpi;return window.jsPDF?(r=new jsPDF).addImage?r.addImage(o,"JPEG",0,0,a,n):alert("Missing jsPDF plugin; Please add the 'addImage' plugin."):alert("Missing jsPDF lib; Don't forget to add the addImage plugin."),r},output:function(r,o){var a=this;return r=AmCharts.extend(AmCharts.extend({},a.cfg.menuItemOutput),r||{}),a.chart.prepareForExport&&a.chart.prepareForExport(),a.generateOutput(r,function(){var t,e=null;10==a.DEBUG&&a.log("OUTPUT",r.format),"image/svg+xml"==r.format||"svg"==r.format?(e=a.generateSVG(),t=a.generateBlob(e,"image/svg+xml"),"save"==r.output?saveAs(t,r.fileName+".svg"):"datastring"==r.output||"datauristring"==r.output||"dataurlstring"==r.output?t="data:image/svg+xml;base64,"+btoa(e):"dataurlnewwindow"==r.output?window.open("data:image/svg+xml;base64,"+btoa(e)):"datauri"==r.output||"dataurl"==r.output?location.href="data:image/svg+xml;base64,"+btoa(e):"datastream"==r.output&&(location.href="data:image/octet-stream;base64,"+e),o&&o.apply(a,[t])):"application/pdf"==r.format||"pdf"==r.format?(e=a.generatePDF(r).output("dataurlstring"),t=a.generateBlob(e,"application/pdf"),"save"==r.output?saveAs(t,r.fileName+".pdf"):"datastring"==r.output||"datauristring"==r.output||"dataurlstring"==r.output?t=e:"dataurlnewwindow"==r.output?window.open(e):"datauri"==r.output||"dataurl"==r.output?location.href=e:"datastream"==r.output&&(location.href=e.replace("application/pdf","application/octet-stream")),o&&o.apply(a,[t])):"image/png"==r.format||"png"==r.format?(e=a.canvas.toDataURL("image/png"),t=a.generateBlob(e,"image/png"),"save"==r.output?saveAs(t,r.fileName+".png"):"datastring"==r.output||"datauristring"==r.output||"dataurlstring"==r.output?t=e:"dataurlnewwindow"==r.output?window.open(e):"datauri"==r.output||"dataurl"==r.output?location.href=e:"datastream"==r.output&&(location.href=e.replace("image/png","image/octet-stream")),o&&o.apply(a,[t])):"image/jpeg"!=r.format&&"jpeg"!=r.format&&"jpg"!=r.format||(e=a.canvas.toDataURL("image/jpeg"),t=a.generateBlob(e,"image/jpeg"),"save"==r.output?saveAs(t,r.fileName+".jpg"):"datastring"==r.output||"datauristring"==r.output||"dataurlstring"==r.output?t=e:"dataurlnewwindow"==r.output?window.open(e):"datauri"==r.output||"dataurl"==r.output?location.href=e:"datastream"==r.output&&(location.href=e.replace("image/jpeg","image/octet-stream")),o&&o.apply(a,[t]))})},polifySVG:function(t){var s=this;function e(t,e){for(var r=t.getElementsByTagName(e),o=r.length;o--;){if(s.cfg.removeImagery)r[o].parentNode.removeChild(r[o]);else{var a=document.createElement("img"),n=document.createElement("canvas"),i=n.getContext("2d");n.width=r[o].getAttribute("width"),n.height=r[o].getAttribute("height"),a.src=r[o].getAttribute("xlink:href"),a.width=r[o].getAttribute("width"),a.height=r[o].getAttribute("height");try{i.drawImage(a,0,0,a.width,a.height),datastring=n.toDataURL()}catch(t){throw datastring=a.src,s.log("Tainted canvas, reached browser CORS security; origin from imagery must be equal to the server!"),new Error(t)}r[o].setAttribute("xlink:href",datastring)}10==s.DEBUG&&s.log("POLIFIED",r[o])}}return 0==AmCharts.IEversion&&(t.setAttribute("xmlns","http://www.w3.org/2000/svg"),s.cfg.removeImagery||t.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink")),10==s.DEBUG&&s.log("POLIFIED",t),e(t,"pattern"),e(t,"image"),s.svgs.push(t),t},generateSVG:function(){var t=document.createElement("svg");t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink");for(var e=0;e<this.processing.buffer.length;e++){var r=document.createElement("g"),o=this.processing.buffer[e];o[0].setAttribute("xmlns","http://www.w3.org/2000/svg"),o[0].setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),r.setAttribute("transform","translate("+o[1].x+","+o[1].y+")"),r.appendChild(o[0]),t.appendChild(r)}return(new XMLSerializer).serializeToString(t)},generateOutput:function(n,i){var s=this,t=s.chart.div.getElementsByTagName("svg"),u=document.createElement("canvas"),l=u.getContext("2d"),e={y:0,x:0},r={};s.processing.buffer=[],s.processing.drawn=0,s.canvas=u,s.svgs=[],10==s.DEBUG&&s.log("START EXPORT"),10==s.DEBUG&&s.log("START BUFFERING");for(var o=0;o<t.length;o++){var a=t[o].parentNode,g=Number(a.style.left.slice(0,-2)),d=Number(a.style.top.slice(0,-2)),p=s.polifySVG(t[o].cloneNode(!0));r=AmCharts.extend({},e);"relative"==a.style.position?(e.x=g||e.x,e.y=d||e.y):(e.x=g,e.y=d),s.processing.buffer.push([p,AmCharts.extend({},e)]),d&&g?e=r:e.y+=d?0:a.offsetHeight,10==s.DEBUG&&s.log("BUFFERED",t[o],e)}10==s.DEBUG&&s.log("END BUFFERING"),10==s.DEBUG&&s.log("START DRAWING",n.render),10==s.DEBUG&&s.log("FILL BACKGROUND"),u.id=AmCharts.getUniqueId(),u.width=s.chart.divRealWidth,u.height=s.chart.divRealHeight;var m={width:!1,height:!1};return s.chart.periodSelector&&(-1!=["left","right"].indexOf(s.chart.periodSelector.position)?(u.width-=s.chart.periodSelector.div.offsetWidth+16,m.width=!0):(u.height-=s.chart.periodSelector.div.offsetHeight,m.height=!0)),s.chart.dataSetSelector&&(-1!=["left","right"].indexOf(s.chart.dataSetSelector.position)?m.width||(u.width-=s.chart.dataSetSelector.div.offsetWidth+16):u.height-=s.chart.dataSetSelector.div.offsetHeight),!n.backgroundColor&&"image/jpeg"!=n.format||(l.fillStyle=n.backgroundColor||"#FFFFFF",l.fillRect(0,0,u.width,u.height)),function t(){var e,r,o,a;if(s.processing.buffer.length==s.processing.drawn||"svg"==n.format)return 10==s.DEBUG&&s.log("END DRAWING"),i();10==s.DEBUG&&s.log("DRAW",s.processing.drawn+1,"OF",s.processing.buffer.length),r=s.processing.buffer[s.processing.drawn],a=(new XMLSerializer).serializeToString(r[0]),o=r[1],10==s.DEBUG&&s.log("SOURCE",a),"browser"==n.render?((e=new Image).id=AmCharts.getUniqueId(),a="data:image/svg+xml;base64,"+btoa(a),e.onload=function(){l.drawImage(this,r[1].x,r[1].y),s.processing.drawn++,10==s.DEBUG&&s.log("ONLOAD",this),t()},e.onerror=function(){10==s.DEBUG&&s.log("ONERROR",this),l.drawImage(this,r[1].x,r[1].y),s.processing.drawn++,t()},e.src=a,10==s.DEBUG&&s.log("ADD",e),!e.complete&&void 0!==e.complete&&void 0!==e.complete||(10==s.DEBUG&&s.log("FORCE ONLOAD",e),e.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",e.src=a)):"canvg"==n.render&&canvg(u,a,{offsetX:o.x,offsetY:o.y,ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0,ignoreClear:!0,renderCallback:function(){s.processing.drawn++,t()}})}()},generateButtons:function(){var g=this,t=document.createElement("div");t.setAttribute("style","width:39px; height:28px; position: absolute;top:"+g.cfg.menuTop+";right:"+g.cfg.menuRight+";bottom:"+g.cfg.menuBottom+";left:"+g.cfg.menuLeft+";box-shadow:0px 0px 1px 0px rgba(0,0,0,0);"),t.setAttribute("class","amExportButton"),t.appendChild(function t(e){var r=document.createElement("ul");r.setAttribute("style","list-style: none; margin: 0; padding: 0;");for(var o=0;o<e.length;o++){var a=document.createElement("li"),n=document.createElement("img"),i=document.createElement("a"),s=e[o],u=null,l=AmCharts.extend(AmCharts.extend({},g.cfg.menuItemStyle),e[o]);(s=AmCharts.extend(AmCharts.extend({},g.cfg.menuItemOutput),s)).icon&&(n.alt="",n.src=s.icon,n.setAttribute("style","margin: 0 auto;border: none;outline: none"),s.iconTitle&&(n.title=s.iconTitle),i.appendChild(n)),i.href="#",s.title&&(n.setAttribute("style","margin-right: 5px;"),i.innerHTML+=s.title),i.setAttribute("style","display: block;"),AmCharts.extend(i.style,l),i.onclick=s.onclick.bind(i,g,s),a.appendChild(i),s.items&&(u=t(s.items),a.appendChild(u),a.onmouseover=function(){u.style.display="block"},a.onmouseout=function(){u.style.display="none"},u.style.display="none"),r.appendChild(a),i.onmouseover=function(){this.style.backgroundColor=l.rollOverBackgroundColor,this.style.color=l.rollOverColor,this.style.borderColor=l.rollOverBorderColor},i.onmouseout=function(){this.style.backgroundColor=l.backgroundColor,this.style.color=l.color,this.style.borderColor=l.borderColor}}return 10==g.DEBUG&&g.log("MENU",r),r}(g.cfg.menuItems)),g.chart.containerDiv.appendChild(t)}});